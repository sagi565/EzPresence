<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Presence - Scheduler</title>
    <style>
        /* CSS Variables - Updated Color Palette */
        :root {
            /* Core brand */
            --color-primary: #9b5de5;
			--color-primary-light: #faf5ff;
			/* Secondary */
            --color-secondary: #fbbf24;
            /* Accents */
            --color-teal: #14b8a6;
            --color-blue: #3b82f6;
            --color-pink: #ec4899;
            /* Neutrals for context (optional) */
            --bg: #f9fafb;
            --surface: #ffffff;
            --text: #111827;
            --muted: #6b7280;
            /* Gradients */
            --grad-innovator: linear-gradient(135deg, var(--color-primary) 0%, var(--color-secondary) 100%);
            --grad-momentum: linear-gradient(135deg, var(--color-primary) 0%, var(--color-blue) 100%);
            --grad-balance:  linear-gradient(135deg, var(--color-primary) 0%, var(--color-teal) 100%);
            --grad-vibe:     linear-gradient(135deg, var(--color-primary) 0%, var(--color-pink) 100%);
        }

        /* RESET */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow-y: auto; overflow-x: hidden; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, 
                var(--bg) 0%, 
                rgba(155, 93, 229, 0.03) 20%, 
                rgba(251, 191, 36, 0.02) 40%, 
                rgba(20, 184, 166, 0.02) 60%, 
                rgba(59, 130, 246, 0.03) 80%, 
                var(--bg) 100%);
            min-height: 100vh;
        }

        /* ===== Navigation Bar ===== */
        .global-nav{
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(155, 93, 229, 0.1);
            padding: 12px 24px;
            display: flex; align-items: center; justify-content: space-between;
            position: sticky; top: 0; z-index: 1000;
            box-shadow: 0 4px 20px rgba(155, 93, 229, 0.08);
        }

        .nav-left{ display: flex; align-items: center; gap: 32px; }

        .logo{
            font-size: 24px; font-weight: 800;
            background: var(--grad-innovator);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
            text-decoration: none; letter-spacing: -0.5px;
        }

        .tenant-brand-selector{
            display: flex; align-items: center;
            background: rgba(255,255,255,0.9);
            border: 2px solid var(--color-secondary);
            border-radius: 16px; padding: 8px 16px;
            cursor: pointer; transition: all .3s cubic-bezier(.4,0,.2,1);
            position: relative; user-select: none;
            white-space: nowrap;
            width: 225px;
        }

        .tenant-brand-selector:hover{
            border-color: var(--color-primary); transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(251, 191, 36, 0.3);
        }

        .tenant-name{ 
            font-weight: 600; color: var(--text); font-size: 15px; 
            flex: 1;
            text-align: left;
        }

        .brand-icon{
            width: 36px; height: 36px; border-radius: 10px;
            background: var(--color-secondary);
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; border: 2px solid rgba(255,255,255,0.3);
            box-shadow: 0 2px 8px rgba(251, 191, 36, 0.2);
            flex-shrink: 0;
            margin-left: 12px;
        }

        .nav-center{ display: flex; gap: 8px; background: transparent; padding: 4px; border-radius: 12px; }
        .nav-btn{ padding: 12px 20px; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; transition: all .2s; text-decoration: none; color: var(--muted); background: transparent; font-size: 14px; }
        .nav-btn:hover{ transform: translateY(-1px); }
        .nav-btn.active{ background: var(--grad-momentum); color: #fff; box-shadow: 0 4px 12px rgba(155, 93, 229, 0.3); }

        .nav-right{ display: flex; align-items: center; gap: 12px; }
        .nav-icon{ width: 44px; height: 44px; border: none; border-radius: 50%; background: rgba(155, 93, 229, 0.08); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all .2s; font-size: 20px; color: var(--muted); }
        .nav-icon:hover{ transform: translateY(-1px); }

        /* Dropdown */
        .brand-dropdown{
            position: absolute; top: calc(100% + 10px); left: 0; 
            width: 225px;
            background: rgba(255,255,255,0.98); border: 1px solid var(--color-secondary);
            border-radius: 12px; padding: 6px; box-shadow: 0 10px 25px rgba(251, 191, 36, 0.15);
            opacity: 0; transform: scale(0.98); pointer-events: none; transition: opacity .15s ease, transform .15s ease; z-index: 2000;
        }
        .brand-dropdown.open{ opacity: 1; transform: scale(1); pointer-events: auto; }

        .brand-option{
            display: flex; align-items: center; gap: 12px; width: 100%; padding: 10px 12px;
            border: 0; background: transparent; border-radius: 8px; cursor: pointer; font-weight: 600; color: var(--text); font-size: 14px;
            transition: all 0.2s ease;
        }
        .brand-option:focus{ outline: none; }
        .brand-option:hover{ background: var(--color-primary-light); }
        .brand-option.active{ 
			background: rgba(251, 191, 36, 0.2);
			color: #d97706;
		}
        .brand-option .opt-icon{
            display: inline-flex; align-items: center; justify-content: center; width: 28px; height: 28px; border-radius: 8px; background: rgba(155, 93, 229, 0.08); font-size: 18px;
        }
        .brand-option.active .opt-icon{
            background: rgba(255, 255, 255, 0.2);
        }

        .brand-option.add-brand{
            padding: 8px 12px;
            font-size: 12px;
            font-weight: 500;
            color: var(--muted);
            border-top: 1px solid rgba(251, 191, 36, 0.2);
            margin-top: 4px;
            cursor: default;
        }
        .brand-option.add-brand:hover{
            background: rgba(20, 184, 166, 0.05);
            color: var(--color-teal);
        }
        .brand-option.add-brand .opt-icon{
            width: 24px; height: 24px;
            font-size: 14px;
            background: rgba(20, 184, 166, 0.1);
        }

        @media (max-width:1024px){
            .nav-center{ display: none; }
            .global-nav{ padding: 12px 16px; }
            .nav-left{ gap: 20px; }
        }
        @media (max-width:768px){
            .tenant-name{ display: none; }
            .logo{ font-size: 20px; }
            .nav-right{ gap: 8px; }
            .nav-icon{ width: 40px; height: 40px; font-size: 18px; }
        }

        /* ===== Scheduler Page Layout ===== */
        .scheduler-container {
            max-width: 1400px; width: 100%; margin: 0 auto; padding: 24px;
            display: flex; flex-direction: column; justify-content: flex-start;
        }

        /* Create button (reused inside date-nav) */
        .create-button { position: relative; display: inline-block; }
        .create-btn { background: var(--grad-innovator); color: white; border: 2px solid var(--color-secondary);
            padding: 10px 16px; border-radius: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;
            transition: all .3s; font-size: 14px; }
        .create-btn:hover { background: var(--grad-vibe); border-color: var(--color-pink); transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(251, 191, 36, 0.4); }
        .create-dropdown { position: absolute; top: 100%; left: 0; margin-top: 8px; background: var(--surface); border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,.15); padding: 8px; min-width: 200px; display: none; z-index: 100; 
            border: 1px solid var(--color-secondary); }
        .create-dropdown.show { display: block; animation: slideDown .3s ease; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px);} to {opacity:1; transform: translateY(0);} }
        .dropdown-item { padding: 12px 16px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: all .2s; }
        .dropdown-item:hover { background: var(--grad-balance); color: white; }

        /* ===== Date Navigation Bar ===== */
        .date-nav { background: var(--surface); border: 1px solid rgba(251, 191, 36, 0.2); border-radius: 16px; padding: 12px 16px; display: grid; gap: 12px;
            grid-template-columns: auto 1fr auto; align-items: center; margin-bottom: 12px;
            box-shadow: 0 2px 12px rgba(251, 191, 36, 0.1); }
        .date-left { display: flex; align-items: center; gap: 8px; }
        .date-controls { display: flex; align-items: center; gap: 20px; justify-content: center; }
        .nav-arrow { background: transparent; border: none; font-size: 16px; cursor: pointer; padding: 8px 12px; border-radius: 8px;
            transition: all .2s; color: var(--muted); display: flex; align-items: center; justify-content: center; }
        .nav-arrow:hover { background: rgba(155, 93, 229, 0.05);}
        .month-year-display { font-size: 18px; font-weight: 600; color: var(--text); cursor: pointer; display: flex; align-items: center; gap: 8px;
            padding: 8px 16px; border-radius: 8px; transition: all .2s; position: relative; min-width: 180px; justify-content: center; }
        .month-year-display:hover { background: rgba(155, 93, 229, 0.05); }
        .view-toggle { display: flex; background: rgba(155, 93, 229, 0.1); border-radius: 10px; padding: 4px; }
        .view-btn { width: 40px; height: 36px; border: none; background: transparent; border-radius: 8px; cursor: pointer; font-size: 18px;
            transition: all .2s; color: var(--muted); display: flex; align-items: center; justify-content: center; position: relative; }
        .view-btn:hover::after { content: attr(data-tooltip); position: absolute; bottom: -30px; white-space: nowrap; background: var(--text); color: white;
            padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight: 500; z-index: 1000; }
        .view-btn.active { background: var(--bg); color: white; box-shadow: 0 2px 8px rgba(251, 191, 36, 0.3); }

        /* Mini Calendar */
        .mini-calendar { position: absolute; top: 100%; left: 50%; transform: translateX(-50%); margin-top: 8px; background: var(--surface);
            border-radius: 12px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15); padding: 16px; display: none; z-index: 100; 
            border: 1px solid var(--color-blue); }
        .mini-calendar.show { display: block; animation: slideDown .3s ease; }
        .mini-cal-grid { display: grid; grid-template-columns: repeat(7, 30px); gap: 4px; }
        .mini-cal-day { width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 6px; cursor: pointer; font-size: 12px; transition: all .2s; }
        .mini-cal-day:hover { background: var(--color-blue); color: white; }

        /* ===== Calendar Grid ===== */
        .calendar-grid { background: white; border-radius: 16px; padding: 16px; box-shadow: 0 4px 20px rgba(0,0,0,.08);
            flex: 1; display: flex; flex-direction: column; margin-bottom: 0; height: 650px; }
        .calendar-header { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; margin-bottom: 1px; background: var(--color-surface);
            border-radius: 12px 12px 0 0; overflow: hidden; }
        .day-header { padding: 10px; text-align: center; font-weight: 600; color: #4b5563; background: white; font-size: 14px; }
        .calendar-body { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: var(--color-surface); flex: 1;
            grid-template-rows: repeat(6, 1fr); }
        .calendar-day { background: white; padding: 8px; position: relative; transition: all .2s; display: flex; flex-direction: column; min-width: 0; 
            min-height: 170px; }
        .calendar-day:hover { background: rgba(155, 93, 229, 0.02); }
        .calendar-day.past { background: var(--color-bg-light); }
        .calendar-day.today { background: rgba(155, 93, 229, 0.05); border: 2px solid rgba(155, 93, 229, 0.2); }
		.calendar-day:not(.past):not(.today):hover:not(:empty) {
			border: 1px dashed rgba(155, 93, 229, 0.4);
		}
        .calendar-day.drag-over { background: rgba(155, 93, 229, 0.1); border: 2px dashed var(--color-primary); }
        .day-number { font-size: 14px; font-weight: 600; color: var(--color-text-primary); text-align: center; margin-bottom: 6px; }
        .calendar-day.today .day-number { color: var(--color-primary); }
		
		.overflow-indicator {
			position: absolute;
			bottom: 4px;
			right: 6px;
			background: rgba(155, 93, 229, 0.1);
			color: var(--color-primary);
			border: 1px solid rgba(155, 93, 229, 0.3);
			border-radius: 10px;
			padding: 1px 6px;
			font-size: 9px;
			font-weight: 600;
		}

        /* ===== Post item (2 lines, smaller badges) ===== */
        .post-item { background: var(--surface); border-radius: 6px; padding: 6px 8px; margin-bottom: 4px; font-size: 11px; 
            box-shadow: 0 1px 3px rgba(155, 93, 229, 0.1); cursor: pointer; transition: all .2s; min-width: 0; 
            border-left: 3px solid transparent; }
        .post-item:hover { transform: translateX(2px); box-shadow: 0 2px 6px rgba(155, 93, 229, 0.15); }
        
        .post-first-line { display: flex; align-items: center; gap: 6px; margin-bottom: 3px; }
        .post-left { display: flex; align-items: center; gap: 6px; min-width: 0; }
        .post-right { margin-left: auto; display: flex; gap: 3px; align-items: center; }
        .status-indicator { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
        .status-indicator.success { background: var(--color-teal); }
        .status-indicator.failed { background: var(--color-pink); }
        .status-indicator.scheduled { background: transparent; border: 1px solid var(--text); }
        .post-time { font-weight: 600; color: var(--text); white-space: nowrap; }
        .media-icon { font-size: 12px; }

        .post-title { font-weight: 700; color: var(--text); font-size: 11px; line-height: 1.2; 
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        /* Platform badges */
        .badge { width: 14px; height: 14px; display: inline-flex; align-items: center; justify-content: center; border-radius: 2px;
            font-weight: 900; font-size: 8px; color: white; box-shadow: 0 1px 2px rgba(0,0,0,.2); letter-spacing: .1px; }
        .badge.yt { background: #ff0033; }
        .badge.ig { background: var(--grad-vibe); }
        .badge.tt { background: var(--text); }
        .badge.fb { background: var(--color-blue); }

        /* ===== My Content Drawer ===== */
        .content-drawer { position: fixed; bottom: 0; left: 0; right: 0; background: var(--surface); border-radius: 24px 24px 0 0;
            box-shadow: 0 -4px 20px rgba(155, 93, 229, 0.1); transition: all .3s cubic-bezier(.4,0,.2,1); z-index: 900; }
.drawer-handle {
    background: 
        repeating-linear-gradient(
            45deg,
            transparent,
            transparent 8px,
            rgba(155, 93, 229, 0.06) 8px,
            rgba(155, 93, 229, 0.06) 9px
        ),
        linear-gradient(180deg, 
            rgba(250, 245, 255, 1) 0%, 
            rgba(255, 255, 255, 1) 100%);
    padding: 12px;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    border-radius: 24px 24px 0 0;
    border: 2px solid rgba(155, 93, 229, 0.15);
    border-bottom: none;
    transition: padding 0.3s ease, gap 0.3s ease;
}
        .drawer-arrow { font-size: 16px; color: var(--muted); transition: all .3s; }
        .drawer-title { font-weight: 600; color: var(--text); font-size: 14px; }
        .drawer-content { max-height: 0; overflow: hidden; transition: max-height .3s ease; }
        .content-drawer.open .drawer-content { max-height: 160px; }
        .content-drawer.open .drawer-arrow { transform: rotate(180deg); color: var(--color-primary); }
        

        .content-drawer.open .drawer-handle {
            padding: 8px 12px;
            gap: 0;
        }

        .content-drawer.open .drawer-title {
            display: none;
        }

        .drawer-inner { padding: 12px 24px 20px; display: flex; gap: 16px; }   

        .drawer-controls { display: flex; gap: 12px; margin-bottom: 0; align-items: flex-start; 
            flex: 1; flex-direction: column; }
        
        .search-bar { width: 100%; max-width: 300px; padding: 8px 14px; border: 2px solid var(--color-primary-light); 
            border-radius: 10px; font-size: 14px; transition: all .2s; margin-bottom: 4px; }
        .search-bar:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(155, 93, 229, 0.1); }
        
        .lists-container { display: flex; flex-direction: column; gap: 8px; padding: 12px; 
            background: rgba(255, 255, 255, 0.5); 
            border: 1px solid rgba(155, 93, 229, 0.12);
            border-radius: 12px; 
            box-shadow: 0 2px 6px rgba(155, 93, 229, 0.08);
            width: 240px; flex-shrink: 0;
            max-height: 200px; overflow-y: auto; }
        
        .lists-container::-webkit-scrollbar { width: 6px; }
        .lists-container::-webkit-scrollbar-track { background: var(--bg); border-radius: 3px; }
        .lists-container::-webkit-scrollbar-thumb { background: rgba(155, 93, 229, 0.5); border-radius: 3px; }
        
        .list-pill { padding: 6px 10px; border: 2px solid rgba(107, 114, 128, 0.3); 
            background: rgba(155, 93, 229, 0.05); border-radius: 8px; 
            font-size: 12px; cursor: pointer; transition: all .2s; display: flex; align-items: center; gap: 8px; 
            font-weight: 500; color: var(--text); width: 100%; }

        .list-pill:hover { background: rgba(155, 93, 229, 0.12); 
            border-color: rgba(155, 93, 229, 0.4); transform: scale(1.02) }

        .list-pill.active { background: rgba(155, 93, 229, 0.15); 
            border-color: var(--color-secondary); 
            box-shadow: 0 2px 6px rgba(155, 93, 229, 0.2); }

        .list-pill-icon { width: 28px; height: 28px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 13px; transition: all .2s; flex-shrink: 0; }

        .list-pill.system .list-pill-icon { background: rgba(251, 191, 36, 0.2); }
        .list-pill.custom .list-pill-icon { background: rgba(20, 184, 166, 0.2); }
        .list-pill.system:hover .list-pill-icon { background: rgba(251, 191, 36, 0.4); }
        .list-pill.custom:hover .list-pill-icon { background: rgba(20, 184, 166, 0.4); }
        .list-pill.system.active .list-pill-icon { background: var(--color-secondary); }
        .list-pill.custom.active .list-pill-icon { background: var(--color-teal); }

        .list-pill-label { flex: 1; text-align: left; overflow: hidden; text-overflow: ellipsis; 
            white-space: nowrap; }

        .list-pill-label .brand-gradient {
            font-weight: 700;
            background: var(--grad-innovator);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .content-list { display: flex; gap: 12px; overflow-x: auto; padding-bottom: 8px; flex: 1; }
        .content-list::-webkit-scrollbar { height: 6px; }
        .content-list::-webkit-scrollbar-track { background: var(--bg); border-radius: 3px; }
        .content-list::-webkit-scrollbar-thumb { background: var(--color-primary); border-radius: 3px; }
        
        .content-card { 
            flex-shrink: 0; 
            width: 152px; 
            height: 92px;
            background: var(--surface);
            padding: 6px;
            cursor: pointer; 
            transition: all .2s; 
            position: relative; 
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .content-card:hover { 
            transform: translateY(-4px); 
            box-shadow: 0 8px 20px rgba(251, 191, 36, 0.3); 
        }

        .content-card.dragging { 
            opacity: .5; 
            cursor: grabbing; 
        }

        /*.content-thumbnail-wrapper { width: 132px; height: 76px; border-radius: 8px;
            margin-bottom: 0; display: flex; align-items: center; justify-content: center; 
            background: var(--surface);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); 
            position: relative; 
            padding: 6px;
            transition: all .2s; }

        .content-card:hover .content-thumbnail-wrapper { 
            box-shadow: 0 8px 20px rgba(251, 191, 36, 0.3); }*/

        .content-thumbnail { 
            width: 100%; 
            height: 100%; 
            border-radius: 6px;
            display: flex; 
            align-items: center; 
            justify-content: center; 
            position: relative; 
        }

        .content-title { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 12px; font-weight: 700; color: #000; text-align: center; line-height: 1.3;
            padding: 4px 8px; width: 90%; z-index: 1; 
            text-shadow: 0 1px 3px rgba(255,255,255,0.8); }

        /* Gradient variations for blurred backgrounds */
        .grad-blur-1 { background: linear-gradient(135deg, rgba(251, 191, 36, 0.7) 0%, rgba(236, 72, 153, 0.7) 100%); }
        .grad-blur-2 { background: linear-gradient(135deg, rgba(59, 130, 246, 0.7) 0%, rgba(20, 184, 166, 0.7) 100%); }
        .grad-blur-3 { background: linear-gradient(135deg, rgba(155, 93, 229, 0.7) 0%, rgba(251, 191, 36, 0.7) 100%); }
        .grad-blur-4 { background: linear-gradient(135deg, rgba(236, 72, 153, 0.7) 0%, rgba(155, 93, 229, 0.7) 100%); }
        .grad-blur-5 { background: linear-gradient(135deg, rgba(20, 184, 166, 0.7) 0%, rgba(59, 130, 246, 0.7) 100%); }
        .grad-blur-6 { background: linear-gradient(135deg, rgba(251, 191, 36, 0.7) 0%, rgba(20, 184, 166, 0.7) 100%); }
        .grad-blur-7 { background: linear-gradient(135deg, rgba(155, 93, 229, 0.7) 0%, rgba(236, 72, 153, 0.7) 100%); }
        .grad-blur-8 { background: linear-gradient(135deg, rgba(59, 130, 246, 0.7) 0%, rgba(155, 93, 229, 0.7) 100%); }

        /* ===== Content Modal ===== */
        .content-modal { 
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            background: rgba(0,0,0,0.7); 
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            display: none; 
            align-items: center; 
            justify-content: center; 
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s ease, backdrop-filter 0.3s ease;
        }

        .content-modal.show { 
            display: flex; 
            animation: fadeIn .3s ease forwards;
        }

        @keyframes fadeIn { 
            from { opacity: 0; } 
            to { opacity: 1; } 
        }
        
        .modal-content { background: var(--surface); border-radius: 16px; padding: 32px; max-width: 900px; width: 90%;
            display: flex; gap: 32px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: slideUp .3s ease; position: relative; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .modal-close { position: absolute; top: 16px; right: 16px; background: rgba(155, 93, 229, 0.1); border: none;
            width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 20px; color: var(--text);
            display: flex; align-items: center; justify-content: center; transition: all .2s; }
        .modal-close:hover { background: var(--color-primary); color: white; transform: rotate(90deg); }
        
        .modal-preview { flex-shrink: 0; width: 280px; aspect-ratio: 9/16; background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border-radius: 12px; display: flex; align-items: center; justify-content: center; position: relative; }
        .modal-play-btn { width: 64px; height: 64px; background: rgba(255,255,255,0.9); border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-size: 28px; cursor: pointer;
            transition: all .2s; padding-left: 4px; }
        .modal-play-btn:hover { background: white; transform: scale(1.1); }
        
        .modal-info { flex: 1; display: flex; flex-direction: column; gap: 20px; }
        .modal-title { font-size: 24px; font-weight: 700; color: var(--text); }
        .modal-meta { display: flex; flex-direction: column; gap: 12px; }
        .meta-row { display: flex; align-items: center; gap: 8px; font-size: 14px; }
        .meta-label { font-weight: 600; color: var(--muted); min-width: 100px; }
        .meta-value { color: var(--text); }


        .like-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            border: 1.5px solid rgba(255, 255, 255, 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            line-height: 1;
            color: white;
            z-index: 2;
            pointer-events: none;
        }

        /* ===== Disabled dropdown item ===== */
        .dropdown-item-disabled { opacity: 0.55; cursor: default !important; }
        .dropdown-item-disabled:hover { background: transparent !important; color: inherit !important; }

        /* ===== New Story Modal Overlay ===== */
        .story-overlay {
            position: fixed; inset: 0;
            background: rgba(17, 24, 39, 0.45);
            backdrop-filter: blur(3px);
            -webkit-backdrop-filter: blur(3px);
            z-index: 1500;
            opacity: 0;
            pointer-events: none;
            transition: opacity .25s ease;
        }
        .story-overlay.active { opacity: 1; pointer-events: auto; }

        /* ===== New Story Modal ===== */
        .new-story-modal {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%) scale(.96);
            z-index: 1600;
            background: var(--surface);
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, .15), 0 0 0 1px rgba(0, 0, 0, .04);
            width: 820px;
            max-width: 94vw;
            max-height: 88vh;
            min-height: 520px;
            overflow-y: auto;
            padding: 0;
            opacity: 0;
            pointer-events: none;
            transition: opacity .25s ease, transform .25s ease;
        }
        .new-story-modal.active {
            opacity: 1;
            pointer-events: auto;
            transform: translate(-50%, -50%) scale(1);
        }

        /* Header — light gray band inspired by WizardMe */
        .nsm-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 18px 28px;
            background: #f8f9fb;
            border-radius: 16px 16px 0 0;
            border-bottom: 1px solid rgba(0, 0, 0, .05);
            flex-shrink: 0;
        }
        .nsm-type-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--color-primary);
            letter-spacing: .3px;
            text-transform: uppercase;
        }
        .nsm-close {
            width: 32px; height: 32px;
            display: flex; align-items: center; justify-content: center;
            border: none; border-radius: 50%;
            background: rgba(0, 0, 0, .06);
            color: var(--muted);
            font-size: 18px;
            cursor: pointer;
            transition: all .2s;
        }
        .nsm-close:hover { background: rgba(0, 0, 0, .12); color: var(--text); }

        /* Title input — shared by Story and Post modals */
        .nsm-title-input {
            width: calc(70% - 28px);
            border: none !important;
            border-bottom: 1px solid rgba(0, 0, 0, .1) !important;
            outline: none;
            font-size: 22px;
            font-weight: 700;
            color: var(--text);
            padding: 16px 0 6px;
            margin-left: 28px;
            background: transparent;
            font-family: inherit;
            transition: border-color .2s ease, border-bottom-width .15s ease;
        }
        .nsm-title-input:hover {
            border-bottom: 1px solid #b796df !important;
        }
        .nsm-title-input:focus {
            border-bottom: 2.5px solid var(--color-primary) !important;
        }
        .nsm-title-input::placeholder { color: #b0b3b8; font-weight: 500; }

        /* Body layout */
        .nsm-body {
            display: flex;
            gap: 24px;
            padding: 16px 28px 24px;
        }
        .nsm-left { flex: 1; display: flex; flex-direction: column; gap: 28px; }
        .nsm-right { 
            flex-shrink: 0; 
            width: 200px;
            display: flex; 
            align-items: center; 
            justify-content: center; 
        }

        /* Section rows */
        .nsm-section {
            display: flex;
            align-items: flex-start;
            gap: 14px;
        }
        .nsm-section-icon {
            width: 28px; height: 28px;
            flex-shrink: 0;
            display: flex; align-items: center; justify-content: center;
            font-size: 17px;
            margin-top: 4px;
            opacity: .65;
        }
        .nsm-section-content { flex: 1; display: flex; flex-direction: column; gap: 8px; }

        /* Chip buttons (date, time, timezone, repeat) */
        .nsm-chip-row { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
        .nsm-chip {
            padding: 7px 14px;
            border: 1.5px solid rgba(0, 0, 0, .1);
            border-radius: 8px;
            background: #fff;
            font-size: 14px;
            font-weight: 500;
            color: var(--text);
            cursor: pointer;
            transition: all .18s;
            display: inline-flex; align-items: center; justify-content: space-between;
            position: relative;
            user-select: none;
        }
        .nsm-chip:hover {
            border-color: var(--color-primary);
            background: rgba(155, 93, 229, .03);
        }
        .nsm-chip.small {
            padding: 5px 10px;
            font-size: 12px;
            color: var(--muted);
        }
        /* Date chip — comfortable width for long day names */
        .nsm-chip.nsm-date-chip {
            min-width: 200px;
        }
        /* Time chip — comfortable width */
        .nsm-chip.nsm-time-chip {
            min-width: 120px;
        }
        .nsm-chip .chip-arrow { font-size: 10px; color: var(--muted); margin-left: 10px; flex-shrink: 0; }
        
        /* Repeat chip — fixed width so it doesn't resize with content */
        .nsm-chip.nsm-repeat-chip {
            min-width: 260px;   /* adjust as needed */
            max-width: 260px;
        }

        /* iPhone-inspired scroll-wheel time picker */
        .nsm-time-picker {
            position: absolute;
            top: calc(100% + 6px); left: 0;
            background: var(--surface);
            border-radius: 14px;
            box-shadow: 0 12px 40px rgba(0, 0, 0, .14);
            border: 1px solid rgba(0, 0, 0, .06);
            padding: 8px 6px;
            z-index: 50;
            display: none;
            width: 270px;
        }
        .nsm-time-picker.show { display: block; animation: slideDown .2s ease; }
        
        /* Wheel container */
        .ntp-wheel {
            display: flex;
            align-items: stretch;
            position: relative;
            height: 180px;
        }
        /* Selection highlight bar — spans across all columns */
        .ntp-wheel::before {
            content: '';
            position: absolute;
            left: 6px; right: 6px;
            top: 50%;
            transform: translateY(-50%);
            height: 36px;
            background: rgba(155, 93, 229, .08);
            border-radius: 8px;
            pointer-events: none;
            z-index: 0;
        }
        
        /* Individual scroll column */
        .ntp-wheel-col {
            flex: 1;
            overflow-y: auto;
            scroll-snap-type: y mandatory;
            scrollbar-width: none;
            position: relative;
            z-index: 1;
        }
        .ntp-wheel-col::-webkit-scrollbar { display: none; }
        
        /* Column header labels */
        .ntp-wheel-header {
            display: flex;
            padding: 0 6px 4px;
        }
        .ntp-wheel-header-label {
            flex: 1;
            text-align: center;
            font-size: 9px;
            font-weight: 700;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: .6px;
        }
        
        /* Spacer items for top/bottom scroll padding */
        .ntp-wheel-spacer {
            height: 72px;  /* 2 item-heights of padding */
            flex-shrink: 0;
            scroll-snap-align: none;
        }
        
        /* Each selectable item */
        .ntp-wheel-item {
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 17px;
            font-weight: 500;
            color: rgba(0, 0, 0, .35);
            cursor: pointer;
            scroll-snap-align: center;
            flex-shrink: 0;
            transition: color .15s, font-weight .15s;
            user-select: none;
            border: none;
            background: transparent;
            width: 100%;
            font-family: inherit;
            padding: 0;
        }
        .ntp-wheel-item:hover { color: rgba(0, 0, 0, .55); }
        .ntp-wheel-item.in-view {
            color: var(--text);
            font-weight: 600;
        }
        
        /* Colon separator */
        .ntp-wheel-separator {
            width: 14px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 700;
            color: var(--muted);
            z-index: 1;
        }
        
        /* Period column (AM/PM) — narrower */
        .ntp-wheel-col.ntp-period-wheel {
            flex: 0.8;
        }

        /* Repeat dropdown */
        .nsm-repeat-dropdown {
            position: absolute;
            top: calc(100% + 6px); left: 0;
            background: var(--surface);
            border-radius: 14px;
            box-shadow: 0 12px 40px rgba(0, 0, 0, .14);
            border: 1px solid rgba(0, 0, 0, .06);
            padding: 6px;
            min-width: 280px;
            z-index: 50;
            display: none;
        }
        .nsm-repeat-dropdown.show { display: block; animation: slideDown .2s ease; }
        .nsm-repeat-option {
            display: flex; align-items: center; gap: 10px;
            width: 100%;
            padding: 10px 14px;
            border: none; background: transparent;
            border-radius: 8px;
            font-size: 13px; font-weight: 500;
            color: var(--text);
            cursor: pointer;
            text-align: left;
            transition: all .12s;
        }
        .nsm-repeat-option:hover { background: #f0f1f3; }
        .nsm-repeat-option.active { 
            background: rgba(155, 93, 229, .06);
            color: var(--color-primary); 
            font-weight: 600; 
        }

        /* Platform buttons — refined EZpresence style */
        .nsm-platform-row { display: flex; flex-wrap: wrap; gap: 10px; }
        .nsm-platform-btn {
            display: inline-flex; align-items: center; gap: 10px;
            padding: 10px 18px;
            border: 1.5px solid rgba(0, 0, 0, .08);
            border-radius: 12px;
            background: #fff;
            font-size: 13px; font-weight: 500;
            color: var(--muted);
            cursor: pointer;
            transition: all .2s ease;
            position: relative;
            white-space: nowrap;
        }
        .nsm-platform-btn .plat-icon {
            width: 24px; height: 24px; border-radius: 6px;
            display: flex; align-items: center; justify-content: center;
            font-size: 10px; font-weight: 900; color: #fff;
            transition: all .2s;
        }
        .nsm-platform-btn .plat-icon.ig { background: var(--grad-vibe); }
        .nsm-platform-btn .plat-icon.fb { background: var(--color-blue); }
        .nsm-platform-btn:hover { 
            border-color: rgba(155, 93, 229, .2);
            background: #faf8ff;
            color: var(--text);
        }
        .nsm-platform-btn.selected {
            border-color: var(--color-primary);
            background: rgba(155, 93, 229, .08);
            color: var(--text);
        }

        /* Content preview (9:16) */
        .nsm-content-preview {
            width: 180px;
            aspect-ratio: 9/16;
            border-radius: 14px;
            border: 2px dashed rgba(0, 0, 0, .1);
            background: #f8f9fb;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            gap: 8px;
            cursor: pointer;
            transition: all .2s;
            overflow: hidden;
            position: relative;
        }
        .nsm-content-preview:hover {
            border-color: var(--color-primary);
            background: rgba(155, 93, 229, .04);
        }
        .nsm-content-preview.drop-hover {
            border-color: var(--color-primary);
            border-style: solid;
            background: rgba(155, 93, 229, .08);
        }
        .nsm-content-preview.has-content {
            border-style: solid;
            border-color: var(--color-primary);
        }
        .nsm-content-placeholder {
            display: flex; flex-direction: column;
            align-items: center; gap: 6px;
            color: var(--muted);
        }
        .nsm-content-placeholder .placeholder-icon {
            font-size: 32px;
            opacity: .7;
        }
        .nsm-content-placeholder .placeholder-text {
            font-size: 11px; font-weight: 500;
            text-align: center;
            padding: 0 8px;
        }
        /* Filled state */
        .nsm-content-filled {
            position: absolute; inset: 0;
            border-radius: 10px;
            display: flex;
            align-items: center; justify-content: center;
        }
        .nsm-content-filled .filled-title {
            font-size: 13px; font-weight: 700;
            color: #000;
            text-align: center;
            padding: 6px 10px;
            text-shadow: 0 1px 3px rgba(255,255,255,.8);
        }
        .nsm-remove-content {
            position: absolute; top: 6px; right: 6px;
            width: 22px; height: 22px;
            border-radius: 50%;
            background: rgba(0,0,0,.5);
            color: #fff;
            border: none;
            font-size: 12px;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            opacity: 0;
            transition: opacity .15s;
            z-index: 2;
        }
        .nsm-content-preview:hover .nsm-remove-content { opacity: 1; }
        .npm-content-preview:hover .nsm-remove-content { opacity: 1; }

        /* Footer actions — light gray band matching header */
        .nsm-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 28px;
            background: #f8f9fb;
            border-top: 1px solid rgba(0, 0, 0, .05);
            border-radius: 0 0 16px 16px;
            flex-shrink: 0;
        }
        .nsm-draft-btn {
            padding: 10px 22px;
            border: none;
            border-radius: 10px;
            background: #fff;
            font-size: 14px; font-weight: 600;
            color: var(--muted);
            cursor: pointer;
            transition: all .18s;
            box-shadow: 0 1px 4px rgba(0, 0, 0, .08);
        }
        .nsm-draft-btn:hover { 
            color: var(--color-primary); 
            box-shadow: 0 2px 8px rgba(155, 93, 229, .15);
        }
        .nsm-schedule-btn {
            padding: 10px 28px;
            border: none;
            border-radius: 10px;
            background: var(--grad-innovator);
            color: #fff;
            font-size: 14px; font-weight: 700;
            cursor: pointer;
            transition: all .2s;
            box-shadow: 0 3px 12px rgba(155, 93, 229, .25);
        }
        .nsm-schedule-btn:hover { transform: translateY(-1px); box-shadow: 0 5px 18px rgba(155, 93, 229, .35); }
        .nsm-schedule-btn:disabled {
            opacity: .5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Date picker popover */
        .nsm-datepicker {
            position: absolute;
            top: calc(100% + 6px); left: 0;
            background: var(--surface);
            border-radius: 12px;
            box-shadow: 0 12px 40px rgba(0,0,0,.18);
            border: 1px solid rgba(155, 93, 229, .12);
            padding: 16px;
            z-index: 50;
            display: none;
            width: 280px;
        }
        .nsm-datepicker.show { display: block; animation: slideDown .2s ease; }
        .nsm-dp-header {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 12px;
        }
        .nsm-dp-header span { font-size: 14px; font-weight: 700; color: var(--text); }
        .nsm-dp-arrow {
            width: 28px; height: 28px;
            border: none; border-radius: 6px;
            background: transparent;
            cursor: pointer;
            font-size: 14px;
            color: var(--muted);
            display: flex; align-items: center; justify-content: center;
            transition: background .15s;
        }
        .nsm-dp-arrow:hover { background: var(--color-primary-light); }
        .nsm-dp-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            text-align: center;
        }
        .nsm-dp-grid .dp-header {
            font-size: 11px; font-weight: 600;
            color: var(--muted);
            padding: 4px 0;
        }
        .nsm-dp-day {
            width: 34px; height: 34px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px; font-weight: 500;
            color: var(--text);
            transition: all .15s;
            border: none; background: transparent;
            margin: auto;
        }
        .nsm-dp-day:hover { background: var(--color-primary-light); }
        .nsm-dp-day.today { font-weight: 700; color: var(--color-primary); }
        .nsm-dp-day.selected { background: var(--color-primary); color: #fff; font-weight: 700; }
        .nsm-dp-day.other-month { color: #d1d5db; }

        /* Timezone popover */
        .nsm-tz-popover {
            position: absolute;
            top: calc(100% + 6px); right: 0;
            background: var(--surface);
            border-radius: 10px;
            box-shadow: 0 10px 32px rgba(0,0,0,.15);
            border: 1px solid rgba(155, 93, 229, .12);
            padding: 12px;
            min-width: 200px;
            z-index: 50;
            display: none;
        }
        .nsm-tz-popover.show { display: block; animation: slideDown .2s ease; }
        .nsm-tz-option {
            display: block; width: 100%;
            padding: 8px 12px;
            border: none; background: transparent;
            border-radius: 6px;
            font-size: 13px; font-weight: 500;
            color: var(--text);
            cursor: pointer;
            text-align: left;
            transition: background .15s;
        }
        .nsm-tz-option:hover { background: var(--color-primary-light); }
        .nsm-tz-option.active { color: var(--color-primary); font-weight: 600; }

        /* Content-picking overlay — dedicated layer above modal, below drawer */
        .content-pick-overlay {
            position: fixed; inset: 0;
            background: rgba(17, 24, 39, 0.55);
            z-index: 1650;
            opacity: 0;
            pointer-events: none;
            transition: opacity .25s ease;
        }
        .content-pick-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        /* Drawer elevated during content picking — always above the pick overlay */
        .content-drawer.nsm-picking {
            z-index: 1700 !important;
        }
        /* Disable drawer handle interaction during content picking */
        .content-drawer.nsm-picking .drawer-handle {
            cursor: default;
            pointer-events: none;
        }

        /* Drag-and-drop type picker */
        .drag-type-picker {
            position: fixed;
            z-index: 2100;
            background: var(--surface);
            border-radius: 12px;
            box-shadow: 0 12px 40px rgba(0,0,0,.2);
            border: 1px solid var(--color-secondary);
            padding: 8px;
            min-width: 200px;
            display: none;
        }
        .drag-type-picker.show { display: block; animation: slideDown .2s ease; }
        .drag-type-picker .dropdown-item { padding: 10px 14px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all .15s; font-size: 14px; }
        .drag-type-picker .dropdown-item:hover { background: var(--grad-balance); color: white; }

        /* ===== New Post Modal Overlay ===== */
        .post-overlay {
            position: fixed; inset: 0;
            background: rgba(17, 24, 39, 0.45);
            backdrop-filter: blur(3px);
            -webkit-backdrop-filter: blur(3px);
            z-index: 1500;
            opacity: 0;
            pointer-events: none;
            transition: opacity .25s ease;
        }
        .post-overlay.active { opacity: 1; pointer-events: auto; }

        /* ===== New Post Modal ===== */
        /* Post modal is the same width as Story (820px) but visibly taller — a portrait rectangle */
        .new-post-modal {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%) scale(.96);
            z-index: 1600;
            background: var(--surface);
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, .15), 0 0 0 1px rgba(0, 0, 0, .04);
            width: 820px;
            max-width: 94vw;
            height: 680px; /* noticeably taller than Story's ~520px natural height */
            max-height: 92vh;
            padding: 0;
            opacity: 0;
            pointer-events: none;
            transition: opacity .25s ease, transform .25s ease;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .new-post-modal.active {
            opacity: 1;
            pointer-events: auto;
            transform: translate(-50%, -50%) scale(1);
        }
        /* Custom scrollbar for post modal inner body */
        .npm-body-scroll { 
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            scrollbar-gutter: stable;
        }
        .npm-body-scroll::-webkit-scrollbar { width: 6px; }
        .npm-body-scroll::-webkit-scrollbar-track { background: transparent; }
        .npm-body-scroll::-webkit-scrollbar-thumb { background: rgba(155, 93, 229, 0.25); border-radius: 3px; }
        .npm-body-scroll::-webkit-scrollbar-thumb:hover { background: rgba(155, 93, 229, 0.45); }

        /* Reuse nsm header/footer/title/section/chip styles via shared classes */

        /* ===== Platform toggle buttons for Post (4 platforms) ===== */
        .npm-platform-btn {
            display: inline-flex; align-items: center; gap: 10px;
            padding: 10px 18px;
            border: 1.5px solid rgba(0, 0, 0, .08);
            border-radius: 12px;
            background: #fff;
            font-size: 13px; font-weight: 500;
            color: var(--muted);
            cursor: pointer;
            transition: all .2s ease;
            position: relative;
            white-space: nowrap;
        }
        .npm-platform-btn .plat-icon {
            width: 24px; height: 24px; border-radius: 6px;
            display: flex; align-items: center; justify-content: center;
            font-size: 10px; font-weight: 900; color: #fff;
            transition: all .2s;
        }
        .npm-platform-btn .plat-icon.ig { background: var(--grad-vibe); }
        .npm-platform-btn .plat-icon.fb { background: var(--color-blue); }
        .npm-platform-btn .plat-icon.yt { background: #ff0033; }
        .npm-platform-btn .plat-icon.tt { background: var(--text); }
        .npm-platform-btn:hover { 
            border-color: rgba(155, 93, 229, .2);
            background: #faf8ff;
            color: var(--text);
        }
        .npm-platform-btn.selected {
            border-color: var(--color-primary);
            background: rgba(155, 93, 229, .08);
            color: var(--text);
        }

        /* ===== Platform Settings Sections ===== */
        .npm-platform-sections {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 8px;
        }

        .npm-plat-section {
            border-radius: 12px;
            overflow: visible;
            transition: all .25s cubic-bezier(.4,0,.2,1);
            animation: npmSectionIn .25s ease;
        }
        @keyframes npmSectionIn {
            from { opacity: 0; transform: translateY(-8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ===== Platform Section Style Options =====
           Switch the active class on .npm-platform-sections to test:
           npm-style-1  Gradient top border + soft shadow
           npm-style-2  Colored left accent bar (original refined)
           npm-style-3  Subtle full border with platform tint background
           npm-style-4  Pill/card style with rounded corners + shadow
           npm-style-5  Minimal — bottom border only, flat
        */

        /* STYLE 1: Gradient top border + soft card shadow */
        .npm-style-1 .npm-plat-section { 
            border: 1px solid rgba(0,0,0,.06);
            box-shadow: 0 2px 10px rgba(0,0,0,.05);
        }
        .npm-style-1 .npm-plat-section::before {
            content: '';
            display: block;
            height: 3px;
            border-radius: 12px 12px 0 0;
        }
        .npm-style-1 .npm-plat-section[data-plat="tiktok"]::before   { background: linear-gradient(90deg, #111827, #6b7280); }
        .npm-style-1 .npm-plat-section[data-plat="instagram"]::before { background: linear-gradient(90deg, #c026d3, #ec4899); }
        .npm-style-1 .npm-plat-section[data-plat="youtube"]::before   { background: linear-gradient(90deg, #ff0033, #ff6b6b); }
        .npm-style-1 .npm-plat-section[data-plat="facebook"]::before  { background: linear-gradient(90deg, #3b82f6, #60a5fa); }

        /* STYLE 2: Colored left accent bar (refined original) */
        .npm-style-2 .npm-plat-section { 
            border: 1.5px solid rgba(0,0,0,.06);
            border-left-width: 3px;
        }
        .npm-style-2 .npm-plat-section[data-plat="tiktok"]   { border-left-color: #111827; }
        .npm-style-2 .npm-plat-section[data-plat="instagram"] { border-left-color: #c026d3; }
        .npm-style-2 .npm-plat-section[data-plat="youtube"]   { border-left-color: #ff0033; }
        .npm-style-2 .npm-plat-section[data-plat="facebook"]  { border-left-color: #3b82f6; }

        /* STYLE 3: Subtle platform tint background + thin border */
        .npm-style-3 .npm-plat-section { 
            border: 1px solid rgba(0,0,0,.06);
        }
        .npm-style-3 .npm-plat-section[data-plat="tiktok"]   { background: rgba(17,24,39,.02); }
        .npm-style-3 .npm-plat-section[data-plat="instagram"] { background: rgba(192,38,211,.03); }
        .npm-style-3 .npm-plat-section[data-plat="youtube"]   { background: rgba(255,0,51,.02); }
        .npm-style-3 .npm-plat-section[data-plat="facebook"]  { background: rgba(59,130,246,.03); }

        /* STYLE 4: Elevated pill card with shadow */
        .npm-style-4 .npm-plat-section { 
            border: none;
            border-radius: 14px;
            box-shadow: 0 1px 4px rgba(0,0,0,.06), 0 4px 16px rgba(155,93,229,.06);
            background: #fff;
        }

        /* STYLE 5: Minimal — bottom divider only */
        .npm-style-5 .npm-plat-section { 
            border: none;
            border-radius: 0;
            border-bottom: 1.5px solid rgba(0,0,0,.06);
        }
        .npm-style-5 .npm-plat-section:last-child { border-bottom: none; }

        .npm-plat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 14px;
            background: #fff;
            cursor: pointer;
            user-select: none;
            transition: background .15s, box-shadow .15s;
            border-radius: 12px 12px 0 0;
        }
        .npm-plat-header:hover { background: #f5f5f7; }

        /* Social account thumbnail with platform badge */
        .npm-account-thumb {
            width: 34px; height: 34px;
            border-radius: 9px;
            background: var(--color-secondary);
            display: flex; align-items: center; justify-content: center;
            font-size: 17px;
            border: 1.5px solid rgba(255,255,255,.4);
            box-shadow: 0 1px 4px rgba(251, 191, 36, 0.15);
            flex-shrink: 0;
            position: relative;
        }
        .npm-account-badge {
            position: absolute;
            bottom: -3px; right: -3px;
            width: 16px; height: 16px;
            border-radius: 4px;
            display: flex; align-items: center; justify-content: center;
            font-size: 7px; font-weight: 900; color: #fff;
            border: 1.5px solid #fff;
        }
        .npm-account-badge.ig { background: var(--grad-vibe); }
        .npm-account-badge.fb { background: var(--color-blue); }
        .npm-account-badge.yt { background: #ff0033; }
        .npm-account-badge.tt { background: var(--text); }

        .npm-plat-header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .npm-plat-header-left .plat-icon {
            width: 22px; height: 22px; border-radius: 5px;
            display: flex; align-items: center; justify-content: center;
            font-size: 9px; font-weight: 900; color: #fff;
        }
        .npm-plat-header-left .plat-icon.ig { background: var(--grad-vibe); }
        .npm-plat-header-left .plat-icon.fb { background: var(--color-blue); }
        .npm-plat-header-left .plat-icon.yt { background: #ff0033; }
        .npm-plat-header-left .plat-icon.tt { background: var(--text); }

        /* Two-line platform name + username */
        .npm-plat-info {
            display: flex;
            flex-direction: column;
            gap: 1px;
        }
        .npm-plat-name {
            font-size: 13.5px;
            font-weight: 400;
            color: var(--text);
            letter-spacing: 0.02em;
        }
        .npm-plat-username {
            font-size: 11px;
            font-weight: 600;
            color: var(--muted);
        }

        /* Platform select toggle (custom checkbox) */
        .npm-plat-toggle {
            width: 18px; height: 18px;
            border-radius: 5px;
            border: 1.5px solid rgba(0,0,0,.15);
            background: #fff;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: all .18s;
            flex-shrink: 0;
        }
        .npm-plat-toggle:hover { border-color: var(--color-primary); }
        .npm-plat-section.selected .npm-plat-toggle {
            background: var(--color-primary);
            border-color: var(--color-primary);
        }
        .npm-plat-toggle-check {
            display: none;
            color: #fff;
            font-size: 11px;
            font-weight: 700;
            line-height: 1;
        }
        .npm-plat-section.selected .npm-plat-toggle-check { display: block; }

        .npm-plat-collapse-arrow {
            font-size: 10px;
            color: var(--muted);
            transition: transform .2s;
        }
        .npm-plat-section.collapsed .npm-plat-collapse-arrow {
            transform: rotate(-90deg);
        }
        /* Hide collapse arrow when not selected */
        .npm-plat-section:not(.selected) .npm-plat-collapse-arrow { visibility: hidden; }

        /* Selected: platform-tinted header background */
        .npm-plat-section.selected[data-plat="instagram"] .npm-plat-header { background: rgba(192, 38, 211, .05); }
        .npm-plat-section.selected[data-plat="facebook"]  .npm-plat-header { background: rgba(59, 130, 246, .05); }
        .npm-plat-section.selected[data-plat="youtube"]   .npm-plat-header { background: rgba(255, 0, 51, .05); }
        .npm-plat-section.selected[data-plat="tiktok"]    .npm-plat-header { background: rgba(37, 244, 238, .08); }
        .npm-plat-section.selected .npm-plat-header:hover {
            filter: brightness(0.97);
        }

        .npm-plat-body {
            padding: 14px;
            display: flex;
            flex-direction: column;
            gap: 14px;
            max-height: 600px;
            overflow: visible;
            transition: max-height .3s ease, padding .3s ease, opacity .2s ease;
            opacity: 1;
        }
        .npm-plat-section.collapsed .npm-plat-body {
            max-height: 0;
            padding: 0 14px;
            opacity: 0;
            overflow: hidden;
        }

        /* ===== Shared form field styles for platform sections ===== */
        .npm-field {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .npm-field-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--muted);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .npm-field-label .npm-optional {
            font-weight: 400;
            font-size: 10px;
            color: #b0b3b8;
        }
        .npm-field-input,
        .npm-field-textarea,
        .npm-field-select {
            width: 100%;
            padding: 8px 12px;
            border: 1.5px solid rgba(0, 0, 0, .1);
            border-radius: 8px;
            font-size: 13px;
            font-family: inherit;
            color: var(--text);
            background: #fff;
            transition: border-color .18s, box-shadow .18s;
            outline: none;
        }
        .npm-field-select {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            padding-right: 30px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6' viewBox='0 0 10 6'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%236b7280' stroke-width='1.5' fill='none' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 10px;
            cursor: pointer;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            font-size: 13px;
            font-weight: 400;
            line-height: 1.4;
        }
        .npm-field-input:focus,
        .npm-field-textarea:focus,
        .npm-field-select:focus {
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(155, 93, 229, .08);
        }
        .npm-field-textarea {
            resize: vertical;
            min-height: 60px;
            line-height: 1.5;
        }
        .npm-field-input:disabled,
        .npm-field-textarea:disabled {
            background: #f3f4f6;
            color: #9ca3af;
            cursor: not-allowed;
        }
        .npm-field-input::placeholder,
        .npm-field-textarea::placeholder { color: #c0c3c8; }

        /* Hashtag highlight — textarea text is invisible, backdrop renders styled text */
        .npm-hashtag-wrap {
            position: relative;
        }
        .npm-hashtag-wrap .npm-field-textarea {
            background: transparent;
            color: transparent;
            caret-color: var(--text);
            position: relative;
            z-index: 1;
        }
        .npm-hashtag-wrap .npm-field-textarea::selection {
            background: rgba(155, 93, 229, .2);
            color: transparent;
        }
        .npm-hashtag-backdrop {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            padding: 8px 12px;
            font-size: 13px;
            font-family: inherit;
            line-height: 1.5;
            color: var(--text);
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow: hidden;
            pointer-events: none;
            border: 1.5px solid transparent;
            border-radius: 8px;
            background: #fff;
        }
        .npm-hashtag-backdrop .hashtag {
            font-weight: 700;
            color: var(--color-primary);
        }

        .npm-char-count {
            font-size: 10px;
            color: #b0b3b8;
            text-align: right;
            margin-top: -2px;
        }

        /* Radio group (privacy level) */
        .npm-radio-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .npm-radio-pill {
            padding: 6px 14px;
            border: 1.5px solid rgba(0, 0, 0, .1);
            border-radius: 20px;
            background: #fff;
            font-size: 12px;
            font-weight: 500;
            color: var(--muted);
            cursor: pointer;
            transition: all .18s;
        }
        .npm-radio-pill:hover {
            border-color: var(--color-primary);
            background: rgba(155, 93, 229, .03);
        }
        .npm-radio-pill.active {
            border-color: var(--color-primary);
            background: rgba(155, 93, 229, .1);
            color: var(--color-primary);
            font-weight: 600;
        }

        /* Toggle switch */
        .npm-toggle-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 4px 0;
        }
        .npm-toggle-label {
            font-size: 13px;
            font-weight: 500;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .npm-toggle-switch {
            position: relative;
            width: 38px; height: 22px;
            background: #d1d5db;
            border-radius: 11px;
            cursor: pointer;
            transition: background .2s;
            flex-shrink: 0;
        }
        .npm-toggle-switch.on { background: var(--color-primary); }
        .npm-toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px; left: 2px;
            width: 18px; height: 18px;
            background: #fff;
            border-radius: 50%;
            transition: transform .2s;
            box-shadow: 0 1px 3px rgba(0,0,0,.2);
        }
        .npm-toggle-switch.on::after { transform: translateX(16px); }

        /* Tooltip icon */
        .npm-tooltip {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 15px; height: 15px;
            border-radius: 50%;
            background: rgba(155, 93, 229, .1);
            font-size: 9px;
            font-weight: 700;
            color: var(--color-primary);
            cursor: help;
            flex-shrink: 0;
        }
        .npm-tooltip .npm-tooltip-text {
            display: none;
            position: absolute;
            bottom: calc(100% + 6px);
            left: 50%;
            transform: translateX(-50%);
            background: var(--text);
            color: #fff;
            font-size: 11px;
            font-weight: 400;
            line-height: 1.4;
            padding: 8px 12px;
            border-radius: 8px;
            white-space: pre-line;
            width: 220px;
            z-index: 1800;
            box-shadow: 0 4px 16px rgba(0,0,0,.25);
            pointer-events: none;
        }
        .npm-tooltip .npm-tooltip-text::after {
            content: '';
            position: absolute;
            top: 100%; left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: var(--text);
        }
        .npm-tooltip:hover .npm-tooltip-text { display: block; }

        /* Tooltip below variant — for fields near top of scrollable area (e.g. Facebook) */
        .npm-tooltip.npm-tooltip-below .npm-tooltip-text {
            bottom: auto;
            top: calc(100% + 6px);
        }
        .npm-tooltip.npm-tooltip-below .npm-tooltip-text::after {
            top: auto;
            bottom: 100%;
            border-top-color: transparent;
            border-bottom-color: var(--text);
        }

        /* Tags input */
        .npm-tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            padding: 6px 10px;
            border: 1.5px solid rgba(0, 0, 0, .1);
            border-radius: 8px;
            background: #fff;
            min-height: 36px;
            align-items: center;
            cursor: text;
            transition: border-color .18s, box-shadow .18s;
        }
        .npm-tags-container:focus-within {
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(155, 93, 229, .08);
        }
        .npm-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            background: rgba(155, 93, 229, .08);
            border: 1px solid rgba(155, 93, 229, .2);
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            color: var(--color-primary);
            animation: npmSectionIn .15s ease;
        }
        .npm-tag-remove {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 14px; height: 14px;
            border-radius: 50%;
            background: rgba(155, 93, 229, .15);
            font-size: 9px;
            cursor: pointer;
            color: var(--color-primary);
            transition: background .15s;
            border: none;
            padding: 0;
        }
        .npm-tag-remove:hover { background: rgba(155, 93, 229, .3); }
        .npm-tags-input {
            border: none;
            outline: none;
            font-size: 12px;
            font-family: inherit;
            color: var(--text);
            min-width: 80px;
            flex: 1;
            padding: 2px 0;
            background: transparent;
        }
        .npm-tags-input::placeholder { color: #c0c3c8; }

        /* Divider inside sections */
        .npm-divider {
            height: 1px;
            background: rgba(0, 0, 0, .06);
            margin: 2px 0;
        }

        /* Content preview for post modal — same as story */
        .npm-content-preview {
            width: 180px;
            aspect-ratio: 9/16;
            border-radius: 14px;
            border: 2px dashed rgba(0, 0, 0, .1);
            background: #f8f9fb;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            gap: 8px;
            cursor: pointer;
            transition: all .2s;
            overflow: hidden;
            position: relative;
        }
        .npm-content-preview:hover {
            border-color: var(--color-primary);
            background: rgba(155, 93, 229, .04);
        }
        .npm-content-preview.drop-hover {
            border-color: var(--color-primary);
            border-style: solid;
            background: rgba(155, 93, 229, .08);
        }
        .npm-content-preview.has-content {
            border-style: solid;
            border-color: var(--color-primary);
        }

        /* Content preview elevated during content picking — positioned fixed above global overlay */
        .nsm-content-preview.pick-elevated,
        .npm-content-preview.pick-elevated {
            border-color: var(--color-primary);
            background: rgba(155, 93, 229, .04) !important;
            box-shadow: 0 0 14px rgba(251, 191, 36, .35), 0 0 28px rgba(251, 191, 36, .15);
        }
        /* During drag-over while picking */
        .nsm-content-preview.pick-elevated.drop-hover,
        .npm-content-preview.pick-elevated.drop-hover {
            border-style: solid;
            background: rgba(155, 93, 229, .08) !important;
        }

        /* Content-picking overlay for post modal */
        .content-pick-overlay-post {
            position: fixed; inset: 0;
            background: rgba(17, 24, 39, 0.55);
            z-index: 1650;
            opacity: 0;
            pointer-events: none;
            transition: opacity .25s ease;
        }
        .content-pick-overlay-post.active {
            opacity: 1;
            pointer-events: auto;
        }
        /* Drawer elevated during post content picking */
        .content-drawer.npm-picking {
            z-index: 1700 !important;
        }
        .content-drawer.npm-picking .drawer-handle {
            cursor: default;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <!-- Global Navigation Bar -->
    <nav class="global-nav">
        <div class="nav-left">
            <a href="#" class="logo">EZpresence</a>

            <div class="tenant-brand-selector"
                 role="button"
                 tabindex="0"
                 aria-haspopup="menu"
                 aria-expanded="false"
                 onclick="toggleBrandDropdown(event)"
                 onkeydown="handleBrandSelectorKeydown(event)">
                <span class="tenant-name">MeatBar Burger</span>
                <div class="brand-icon">🍔</div>

                <div id="brandDropdown" class="brand-dropdown" role="menu" aria-label="Select brand">
                    <button class="brand-option active" role="menuitem" data-brand="MeatBar Burger" data-icon="🍔">
                        <span class="opt-icon">🍔</span>
                        <span>MeatBar Burger</span>
                    </button>
                    <button class="brand-option" role="menuitem" data-brand="MeatBar Steakhouse" data-icon="🥩">
                        <span class="opt-icon">🥩</span>
                        <span>MeatBar Steakhouse</span>
                    </button>
                    <button class="brand-option add-brand" role="menuitem" data-add-brand="true">
                        <span class="opt-icon">➕</span>
                        <span>Add a new Brand</span>
                    </button>
                </div>
            </div>
        </div>

        <div class="nav-center">
            <a href="#" class="nav-btn">🏠 Home</a>
            <a href="#" class="nav-btn">▶️ Content</a>
            <a href="#" class="nav-btn">🎬 Studio</a>
            <a href="#" class="nav-btn active">📅 Scheduler</a>
            <a href="#" class="nav-btn">📊 Dashboard</a>
        </div>

        <div class="nav-right">
            <button class="nav-icon">🔔</button>
            <button class="nav-icon">👤</button>
        </div>
    </nav>

    <!-- Scheduler Container -->
    <div class="scheduler-container" id="schedulerContainer">
        <!-- Date Navigation Bar -->
        <div class="date-nav" id="dateNav">
            <div class="date-left">
                <div class="create-button">
                    <button class="create-btn" onclick="toggleCreateDropdown()">
                        <span style="font-size: 16px;">➕</span> Create
                    </button>
                    <div class="create-dropdown" id="createDropdown">
                        <div class="dropdown-item" onclick="openNewPostModal()"><span>📱</span><span>New Post</span></div>
                        <div class="dropdown-item" onclick="openNewStoryModal()"><span>📖</span><span>New Story</span></div>
                        <div class="dropdown-item dropdown-item-disabled" onclick="createPost('ai')"><span>🤖</span><span>New AI Series <small style="opacity:.5">(coming soon)</small></span></div>
                    </div>
                </div>
            </div>
            <div class="date-controls">
                <button class="nav-arrow" onclick="changeMonth(-1)">
                    <svg width="8" height="14" viewBox="0 0 8 14" fill="currentColor">
                        <path d="M7 1L1 7L7 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                    </svg>
                </button>
                <div class="month-year-display" onclick="toggleMiniCalendar()">
                    <span id="currentMonth">August 2025</span>
                    <span style="font-size: 12px;">▼</span>
                    <div class="mini-calendar" id="miniCalendar">
                        <div class="mini-cal-grid"><!-- populated by JS --></div>
                    </div>
                </div>
                <button class="nav-arrow" onclick="changeMonth(1)">
                    <svg width="8" height="14" viewBox="0 0 8 14" fill="currentColor">
                        <path d="M1 1L7 7L1 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                    </svg>
                </button>
            </div>
            <div class="view-toggle">
                <button class="view-btn active" onclick="switchView('month')" data-tooltip="Switch to calendar">📅</button>
                <button class="view-btn" onclick="switchView('list')" data-tooltip="Switch to list">📋</button>
            </div>
        </div>

        <!-- Calendar Grid -->
        <div class="calendar-grid">
            <div class="calendar-header">
                <div class="day-header">Sunday</div>
                <div class="day-header">Monday</div>
                <div class="day-header">Tuesday</div>
                <div class="day-header">Wednesday</div>
                <div class="day-header">Thursday</div>
                <div class="day-header">Friday</div>
                <div class="day-header">Saturday</div>
            </div>
            <div class="calendar-body" id="calendarBody"><!-- populated by JS --></div>
        </div>
    </div>

    <!-- My Content Drawer -->
    <div class="content-drawer" id="contentDrawer">
        <div class="drawer-handle" onclick="toggleDrawer()">
            <span class="drawer-arrow">▲</span>
            <span class="drawer-title">My Content</span>
        </div>
        <div class="drawer-content">
            <div class="drawer-inner">
                <div class="drawer-controls">
                    <input type="text" class="search-bar" placeholder="Search across all your content..." oninput="applyFilters()" id="searchInput">
                    <div class="content-list" id="contentList">
                        <!-- Content cards populated by JS -->
                    </div>
                </div>
                <div class="lists-container">
                    <button class="list-pill system active" data-list="my-videos" onclick="selectList(this)">
                        <span class="list-pill-icon">🎥</span>
                        <span class="list-pill-label">My Videos</span>
                    </button>
                    <button class="list-pill system" data-list="my-images" onclick="selectList(this)">
                        <span class="list-pill-icon">🖼️</span>
                        <span class="list-pill-label">My Images</span>
                    </button>
                    <button class="list-pill system" data-list="creators" onclick="selectList(this)">
                        <span class="list-pill-icon">👥</span>
                        <span class="list-pill-label">Made by <span class="brand-gradient">Creators</span></span>
                    </button>
                    <button class="list-pill system" data-list="producer" onclick="selectList(this)">
                        <span class="list-pill-icon">🎯</span>
                        <span class="list-pill-label">Made by <span class="brand-gradient">Producer Mode</span></span>
                    </button>
                    <button class="list-pill custom" data-list="menu-project" onclick="selectList(this)">
                        <span class="list-pill-icon">📋</span>
                        <span class="list-pill-label">New Menu Awareness</span>
                    </button>
                    <button class="list-pill custom" data-list="summer-campaign" onclick="selectList(this)">
                        <span class="list-pill-icon">☀️</span>
                        <span class="list-pill-label">Summer Campaign</span>
                    </button>
                    <button class="list-pill custom" data-list="customer-stories" onclick="selectList(this)">
                        <span class="list-pill-icon">💬</span>
                        <span class="list-pill-label">Customer Stories</span>
                    </button>
                    <button class="list-pill custom" data-list="recipe-series" onclick="selectList(this)">
                        <span class="list-pill-icon">📖</span>
                        <span class="list-pill-label">Recipe Series</span>
                    </button>
                    <button class="list-pill custom" data-list="behind-scenes" onclick="selectList(this)">
                        <span class="list-pill-icon">🎭</span>
                        <span class="list-pill-label">Behind the Scenes</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Content Modal -->
    <div class="content-modal" id="contentModal" onclick="closeModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <button class="modal-close" onclick="closeModal()">✕</button>
            <div class="modal-preview">
                <div class="modal-play-btn">▶</div>
            </div>
            <div class="modal-info">
                <h2 class="modal-title" id="modalTitle">Content Title</h2>
                <div class="modal-meta">
                    <div class="meta-row">
                        <span class="meta-label">Type:</span>
                        <span class="meta-value" id="modalType">Video</span>
                    </div>
                    <div class="meta-row">
                        <span class="meta-label">Duration:</span>
                        <span class="meta-value" id="modalDuration">0:45</span>
                    </div>
                    <div class="meta-row">
                        <span class="meta-label">Format:</span>
                        <span class="meta-value" id="modalFormat">9:16 (Vertical)</span>
                    </div>
                    <div class="meta-row">
                        <span class="meta-label">Created:</span>
                        <span class="meta-value" id="modalCreated">August 15, 2025</span>
                    </div>
                    <div class="meta-row">
                        <span class="meta-label">Source:</span>
                        <span class="meta-value" id="modalSource">Presence AI</span>
                    </div>
                    <div class="meta-row">
                        <span class="meta-label">Status:</span>
                        <span class="meta-value" id="modalStatus">Ready to Publish</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- New Story Overlay -->
    <div class="story-overlay" id="storyOverlay" onclick="handleOverlayClick()"></div>

    <!-- Content-picking overlay — unified for Story and Post modals -->
    <div class="content-pick-overlay" id="contentPickOverlay" onclick="cancelContentPicking()"></div>

    <!-- Post Overlay -->
    <div class="post-overlay" id="postOverlay" onclick="handlePostOverlayClick()"></div>

    <!-- ===== New Post Modal ===== -->
    <div class="new-post-modal" id="newPostModal">
        <!-- Header -->
        <div class="nsm-header">
            <span class="nsm-type-label" style="font-size: 28px; line-height: 1;">📱</span>
            <button class="nsm-close" onclick="closeNewPostModal()">✕</button>
        </div>

        <!-- Scrollable inner body (title + fields) -->
        <div class="npm-body-scroll">
            <!-- Title -->
            <input type="text" class="nsm-title-input" id="npmTitle" placeholder="New post" maxlength="80">

            <!-- Body -->
            <div class="nsm-body" style="gap: 24px;">
                <!-- Left column: Time + Socials + Platform sections -->
                <div class="nsm-left" style="gap: 20px;">
                    <!-- Time section (reuses nsm styles) -->
                    <div class="nsm-section">
                        <div class="nsm-section-icon">🕐</div>
                        <div class="nsm-section-content">
                            <div class="nsm-chip-row">
                                <!-- Date chip -->
                                <div class="nsm-chip nsm-date-chip" id="npmDateChip" onclick="toggleNpmDatepicker(event)">
                                    <span id="npmDateLabel">Monday, February 3</span>
                                    <span class="chip-arrow">▾</span>
                                    <div class="nsm-datepicker" id="npmDatepicker" onclick="event.stopPropagation()">
                                        <div class="nsm-dp-header">
                                            <button class="nsm-dp-arrow" onclick="npmDpNav(-1)">‹</button>
                                            <span id="npmDpTitle">February 2026</span>
                                            <button class="nsm-dp-arrow" onclick="npmDpNav(1)">›</button>
                                        </div>
                                        <div class="nsm-dp-grid" id="npmDpGrid"></div>
                                    </div>
                                </div>
                                <!-- Time chip -->
                                <div class="nsm-chip nsm-time-chip" id="npmTimeChip" onclick="toggleNpmTimePicker(event)">
                                    <span id="npmTimeLabel">4:00 PM</span>
                                    <span class="chip-arrow">▾</span>
                                    <div class="nsm-time-picker" id="npmTimePicker" onclick="event.stopPropagation()">
                                        <div class="ntp-wheel-header">
                                            <span class="ntp-wheel-header-label">Hour</span>
                                            <span class="ntp-wheel-header-label" style="flex:0.15"></span>
                                            <span class="ntp-wheel-header-label">Minute</span>
                                            <span class="ntp-wheel-header-label" style="flex:0.8">  </span>
                                        </div>
                                        <div class="ntp-wheel">
                                            <div class="ntp-wheel-col" id="npmHourWheel"></div>
                                            <div class="ntp-wheel-separator">:</div>
                                            <div class="ntp-wheel-col" id="npmMinWheel"></div>
                                            <div class="ntp-wheel-col ntp-period-wheel" id="npmPeriodWheel"></div>
                                        </div>
                                    </div>
                                </div>
                                <!-- Timezone chip -->
                                <div class="nsm-chip small" onclick="alert('Timezone settings coming soon!')">
                                    <span>Timezone</span>
                                    <span class="chip-arrow">▾</span>
                                </div>
                            </div>
                            <!-- Repeat chip -->
                            <div class="nsm-chip-row">
                                <div class="nsm-chip nsm-repeat-chip" id="npmRepeatChip" onclick="toggleNpmRepeat(event)" style="position:relative;">
                                    <span id="npmRepeatLabel">Does not repeat</span>
                                    <span class="chip-arrow">▾</span>
                                    <div class="nsm-repeat-dropdown" id="npmRepeatDropdown" onclick="event.stopPropagation()">
                                        <button class="nsm-repeat-option active" onclick="selectNpmRepeat(this, 'Does not repeat')">Does not repeat</button>
                                        <button class="nsm-repeat-option" onclick="selectNpmRepeat(this, 'Daily')">Daily</button>
                                        <button class="nsm-repeat-option" id="npmRepeatWeekly" onclick="selectNpmRepeat(this, '')">Weekly on Monday</button>
                                        <button class="nsm-repeat-option" id="npmRepeatMonthly" onclick="selectNpmRepeat(this, '')">Monthly on the first Monday</button>
                                        <button class="nsm-repeat-option" id="npmRepeatAnnually" onclick="selectNpmRepeat(this, '')">Annually on February 3</button>
                                        <button class="nsm-repeat-option" onclick="selectNpmRepeat(this, 'Custom...')">Custom...</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Socials section (platform sections — always visible) -->
                    <div class="nsm-section">
                        <div class="nsm-section-icon">📲</div>
                        <div class="nsm-section-content">
                            <!-- Platform-specific sections container (all 4 shown, selectable) -->
                            <div class="npm-platform-sections npm-style-3" id="npmPlatformSections"></div>
                        </div>
                    </div>
                </div>

                <!-- Right column: Content preview — pinned to top of flex -->
                <div class="nsm-right" style="align-self: flex-start;">
                    <div class="npm-content-preview" id="npmContentPreview" onclick="openPostContentPicker()">
                        <div class="nsm-content-placeholder" id="npmPlaceholder">
                            <span class="placeholder-icon">🎞️</span>
                            <span class="placeholder-text">Click to add content</span>
                        </div>
                        <div class="nsm-content-filled" id="npmContentFilled" style="display:none;"></div>
                        <button class="nsm-remove-content" id="npmRemoveContent" onclick="removePostContent(event)" style="display:none;">✕</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="nsm-footer">
            <button class="nsm-draft-btn" onclick="savePostAsDraft()">Save as Draft</button>
            <button class="nsm-schedule-btn" id="npmScheduleBtn" onclick="schedulePost()">Schedule</button>
        </div>
    </div>

    <!-- New Story Modal -->
    <div class="new-story-modal" id="newStoryModal">
        <!-- Header -->
        <div class="nsm-header">
            <span class="nsm-type-label" style="font-size: 28px; line-height: 1;">📖</span>
            <button class="nsm-close" onclick="closeNewStoryModal()">✕</button>
        </div>

        <!-- Title -->
        <input type="text" class="nsm-title-input" id="nsmTitle" placeholder="New story" maxlength="80">

        <!-- Body -->
        <div class="nsm-body">
            <!-- Left column: Time + Socials -->
            <div class="nsm-left">
                <!-- Time section -->
                <div class="nsm-section">
                    <div class="nsm-section-icon">🕐</div>
                    <div class="nsm-section-content">
                        <div class="nsm-chip-row">
                            <!-- Date chip -->
                            <div class="nsm-chip nsm-date-chip" id="nsmDateChip" onclick="toggleNsmDatepicker(event)">
                                <span id="nsmDateLabel">Monday, February 3</span>
                                <span class="chip-arrow">▾</span>
                                <!-- Date picker popover -->
                                <div class="nsm-datepicker" id="nsmDatepicker" onclick="event.stopPropagation()">
                                    <div class="nsm-dp-header">
                                        <button class="nsm-dp-arrow" onclick="nsmDpNav(-1)">‹</button>
                                        <span id="nsmDpTitle">February 2026</span>
                                        <button class="nsm-dp-arrow" onclick="nsmDpNav(1)">›</button>
                                    </div>
                                    <div class="nsm-dp-grid" id="nsmDpGrid"></div>
                                </div>
                            </div>
                            <!-- Time chip (custom picker) -->
                            <div class="nsm-chip nsm-time-chip" id="nsmTimeChip" onclick="toggleTimePicker(event)">
                                <span id="nsmTimeLabel">4:00 PM</span>
                                <span class="chip-arrow">▾</span>
                                <!-- iPhone-inspired scroll wheel time picker -->
                                <div class="nsm-time-picker" id="nsmTimePicker" onclick="event.stopPropagation()">
                                    <div class="ntp-wheel-header">
                                        <span class="ntp-wheel-header-label">Hour</span>
                                        <span class="ntp-wheel-header-label" style="flex:0.15"></span>
                                        <span class="ntp-wheel-header-label">Minute</span>
                                        <span class="ntp-wheel-header-label" style="flex:0.8">  </span>
                                    </div>
                                    <div class="ntp-wheel">
                                        <div class="ntp-wheel-col" id="ntpHourWheel"></div>
                                        <div class="ntp-wheel-separator">:</div>
                                        <div class="ntp-wheel-col" id="ntpMinWheel"></div>
                                        <div class="ntp-wheel-col ntp-period-wheel" id="ntpPeriodWheel"></div>
                                    </div>
                                </div>
                            </div>
                            <!-- Timezone chip -->
                            <div class="nsm-chip small" onclick="alert('Timezone settings coming soon!')">
                                <span>Timezone</span>
                                <span class="chip-arrow">▾</span>
                            </div>
                        </div>
                        <!-- Repeat chip -->
                        <div class="nsm-chip-row">
                            <div class="nsm-chip nsm-repeat-chip" id="nsmRepeatChip" onclick="toggleNsmRepeat(event)" style="position:relative;">
                                <span id="nsmRepeatLabel">Does not repeat</span>
                                <span class="chip-arrow">▾</span>
                                <div class="nsm-repeat-dropdown" id="nsmRepeatDropdown" onclick="event.stopPropagation()">
                                    <button class="nsm-repeat-option active" onclick="selectRepeat(this, 'Does not repeat')">Does not repeat</button>
                                    <button class="nsm-repeat-option" onclick="selectRepeat(this, 'Daily')">Daily</button>
                                    <button class="nsm-repeat-option" id="nsmRepeatWeekly" onclick="selectRepeat(this, '')">Weekly on Monday</button>
                                    <button class="nsm-repeat-option" id="nsmRepeatMonthly" onclick="selectRepeat(this, '')">Monthly on the first Monday</button>
                                    <button class="nsm-repeat-option" id="nsmRepeatAnnually" onclick="selectRepeat(this, '')">Annually on February 3</button>
                                    <button class="nsm-repeat-option" onclick="selectRepeat(this, 'Custom...')">Custom...</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Socials section — platform sections (Story: Instagram + Facebook only) -->
                <div class="nsm-section">
                    <div class="nsm-section-icon">📲</div>
                    <div class="nsm-section-content">
                        <div class="npm-platform-sections npm-style-3" id="nsmPlatformSections"></div>
                    </div>
                </div>
            </div>

            <!-- Right column: Content preview -->
            <div class="nsm-right">
                <div class="nsm-content-preview" id="nsmContentPreview" onclick="openContentPicker()">
                    <div class="nsm-content-placeholder" id="nsmPlaceholder">
                        <span class="placeholder-icon">🎞️</span>
                        <span class="placeholder-text">Click to add content</span>
                    </div>
                    <!-- Filled state (hidden by default) -->
                    <div class="nsm-content-filled" id="nsmContentFilled" style="display:none;"></div>
                    <button class="nsm-remove-content" id="nsmRemoveContent" onclick="removeStoryContent(event)" style="display:none;">✕</button>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="nsm-footer">
            <button class="nsm-draft-btn" onclick="saveStoryAsDraft()">Save as Draft</button>
            <button class="nsm-schedule-btn" id="nsmScheduleBtn" onclick="scheduleStory()">Schedule</button>
        </div>
    </div>

    <!-- Drag & drop type picker (contextual) -->
    <div class="drag-type-picker" id="dragTypePicker">
        <div class="dropdown-item" onclick="dragCreatePost()"><span>📱</span><span>New Post</span></div>
        <div class="dropdown-item" onclick="dragCreateStory()"><span>📖</span><span>New Story</span></div>
        <div class="dropdown-item dropdown-item-disabled"><span>🤖</span><span>New AI Series <small style="opacity:.5">(coming soon)</small></span></div>
    </div>

    <script>
        // ===== Calendar state =====
        const today = new Date(2025, 7, 20); // August 20, 2025 (fixed for demo)
        let currentMonth = today.getMonth();
        let currentYear = today.getFullYear();

        // Platform badges map
        const PLATFORM_BADGES = {
            youtube: { cls: 'yt', label: 'YT' },
            instagram: { cls: 'ig', label: 'IG' },
            tiktok: { cls: 'tt', label: 'TT' },
            facebook: { cls: 'fb', label: 'FB' }
        };
		
		// Brand-specific posts
		const BRAND_DATA = {
			'MeatBar Burger': {
				posts: [
					// June 2025
					{ date: new Date(2025, 5, 5), time: '11:00 AM', platforms: ['facebook','instagram'], status: 'success', media: 'image', title: 'Summer Burger Launch' },
					{ date: new Date(2025, 5, 12), time: '2:00 PM', platforms: ['youtube'], status: 'success', media: 'video', title: 'Grilling Techniques 101' },
					{ date: new Date(2025, 5, 18), time: '5:00 PM', platforms: ['tiktok','instagram'], status: 'success', media: 'video', title: 'Quick Burger Assembly' },
					{ date: new Date(2025, 5, 25), time: '12:30 PM', platforms: ['facebook'], status: 'failed', media: 'image', title: 'Weekend BBQ Special' },
					{ date: new Date(2025, 5, 28), time: '4:00 PM', platforms: ['instagram','youtube'], status: 'success', media: 'image', title: 'Fresh Ingredient Showcase' },
					
					// July 2025
					{ date: new Date(2025, 6, 3), time: '10:00 AM', platforms: ['facebook','instagram'], status: 'success', media: 'image', title: 'Independence Day Menu' },
					{ date: new Date(2025, 6, 8), time: '1:00 PM', platforms: ['tiktok'], status: 'success', media: 'video', title: 'Behind the Scenes' },
					{ date: new Date(2025, 6, 15), time: '6:00 PM', platforms: ['youtube','facebook'], status: 'success', media: 'video', title: 'Customer Testimonials' },
					{ date: new Date(2025, 6, 22), time: '3:30 PM', platforms: ['instagram'], status: 'success', media: 'image', title: 'Summer Happy Hour' },
					{ date: new Date(2025, 6, 29), time: '11:30 AM', platforms: ['facebook','tiktok'], status: 'failed', media: 'video', title: 'Monthly Burger Challenge' },
					
					// August 2025 (current month)
					{ date: new Date(2025, 7, 2), time: '9:00 AM', platforms: ['instagram','facebook'], status: 'success', media: 'image', title: 'Back to School Special' },
					{ date: new Date(2025, 7, 8), time: '2:00 PM', platforms: ['youtube'], status: 'success', media: 'video', title: 'Kitchen Tour Video' },
					{ date: new Date(2025, 7, 12), time: '12:00 PM', platforms: ['facebook'], status: 'success', media: 'image', title: 'Fresh Menu Launch' },
					{ date: new Date(2025, 7, 15), time: '9:00 AM', platforms: ['instagram','tiktok'], status: 'success', media: 'image', title: 'Customer Favorites' },
					{ date: new Date(2025, 7, 15), time: '6:30 PM', platforms: ['facebook','youtube'], status: 'success', media: 'video', title: 'Evening Specials' },
					{ date: new Date(2025, 7, 15), time: '9:30 PM', platforms: ['instagram'], status: 'success', media: 'image', title: 'Late Night Menu' },
					{ date: new Date(2025, 7, 22), time: '10:00 AM', platforms: ['instagram'], status: 'scheduled', media: 'image', title: 'Chef Special Today' },
					{ date: new Date(2025, 7, 22), time: '4:00 PM', platforms: ['youtube','facebook'], status: 'scheduled', media: 'video', title: 'Limited Time Offer' },
					{ date: new Date(2025, 7, 26), time: '3:00 PM', platforms: ['tiktok'], status: 'scheduled', media: 'video', title: 'Summer Menu Update' },
					{ date: new Date(2025, 7, 29), time: '1:00 PM', platforms: ['facebook','instagram'], status: 'scheduled', media: 'image', title: 'Fresh Daily Ingredients' },
					
					// September 2025
					{ date: new Date(2025, 8, 5), time: '11:00 AM', platforms: ['facebook','instagram'], status: 'scheduled', media: 'image', title: 'Fall Menu Preview' },
					{ date: new Date(2025, 8, 12), time: '2:30 PM', platforms: ['youtube'], status: 'scheduled', media: 'video', title: 'Seasonal Ingredients' },
					{ date: new Date(2025, 8, 18), time: '5:00 PM', platforms: ['tiktok','instagram'], status: 'scheduled', media: 'video', title: 'Quick Fall Recipes' },
					{ date: new Date(2025, 8, 25), time: '12:00 PM', platforms: ['facebook'], status: 'scheduled', media: 'image', title: 'Comfort Food Special' },
					{ date: new Date(2025, 8, 28), time: '4:30 PM', platforms: ['instagram','youtube'], status: 'scheduled', media: 'image', title: 'Harvest Season Menu' },
					
					// October 2025
					{ date: new Date(2025, 9, 3), time: '10:30 AM', platforms: ['facebook','instagram'], status: 'scheduled', media: 'image', title: 'Pumpkin Spice Burger' },
					{ date: new Date(2025, 9, 10), time: '1:00 PM', platforms: ['tiktok'], status: 'scheduled', media: 'video', title: 'Halloween Themed Menu' },
					{ date: new Date(2025, 9, 17), time: '6:00 PM', platforms: ['youtube','facebook'], status: 'scheduled', media: 'video', title: 'Spooky Burger Challenge' },
					{ date: new Date(2025, 9, 24), time: '3:00 PM', platforms: ['instagram'], status: 'scheduled', media: 'image', title: 'October Fest Special' },
					{ date: new Date(2025, 9, 31), time: '7:00 PM', platforms: ['facebook','tiktok'], status: 'scheduled', media: 'video', title: 'Halloween Night Special' }
				]
			},
			'MeatBar Steakhouse': {
				posts: [
					// June 2025
					{ date: new Date(2025, 5, 7), time: '7:00 PM', platforms: ['instagram','facebook'], status: 'success', media: 'image', title: 'Summer Steak Selection' },
					{ date: new Date(2025, 5, 14), time: '8:00 PM', platforms: ['youtube'], status: 'success', media: 'video', title: 'Perfect Steak Preparation' },
					{ date: new Date(2025, 5, 21), time: '6:30 PM', platforms: ['facebook','instagram'], status: 'success', media: 'image', title: 'Wine Pairing Night' },
					{ date: new Date(2025, 5, 28), time: '7:30 PM', platforms: ['tiktok'], status: 'failed', media: 'video', title: 'Quick Grilling Tips' },
					
					// July 2025
					{ date: new Date(2025, 6, 5), time: '6:00 PM', platforms: ['facebook','instagram'], status: 'success', media: 'image', title: 'Premium Cut Showcase' },
					{ date: new Date(2025, 6, 12), time: '8:30 PM', platforms: ['youtube'], status: 'success', media: 'video', title: 'Chef Masterclass' },
					{ date: new Date(2025, 6, 19), time: '7:00 PM', platforms: ['instagram'], status: 'success', media: 'image', title: 'Date Night Special' },
					{ date: new Date(2025, 6, 26), time: '6:45 PM', platforms: ['facebook','tiktok'], status: 'success', media: 'video', title: 'Behind the Grill' },
					
					// August 2025 (current month)
					{ date: new Date(2025, 7, 3), time: '7:00 PM', platforms: ['instagram','facebook'], status: 'success', media: 'image', title: 'Prime Cut Selection' },
					{ date: new Date(2025, 7, 10), time: '8:00 PM', platforms: ['youtube'], status: 'success', media: 'video', title: 'Steak Preparation Masterclass' },
					{ date: new Date(2025, 7, 17), time: '6:30 PM', platforms: ['facebook','instagram'], status: 'success', media: 'image', title: 'Weekend Steak Special' },
					{ date: new Date(2025, 7, 24), time: '7:30 PM', platforms: ['tiktok'], status: 'scheduled', media: 'video', title: 'Quick Marinade Tips' },
					{ date: new Date(2025, 7, 31), time: '8:00 PM', platforms: ['instagram','youtube'], status: 'scheduled', media: 'image', title: 'Monthly Prime Selection' },
					
					// September 2025
					{ date: new Date(2025, 8, 7), time: '6:30 PM', platforms: ['facebook','instagram'], status: 'scheduled', media: 'image', title: 'Fall Steak Menu' },
					{ date: new Date(2025, 8, 14), time: '7:00 PM', platforms: ['youtube'], status: 'scheduled', media: 'video', title: 'Seasonal Wine Pairings' },
					{ date: new Date(2025, 8, 21), time: '8:00 PM', platforms: ['instagram'], status: 'scheduled', media: 'image', title: 'Executive Chef Special' },
					{ date: new Date(2025, 8, 28), time: '6:45 PM', platforms: ['facebook','tiktok'], status: 'scheduled', media: 'video', title: 'Harvest Season Steaks' },
					
					// October 2025
					{ date: new Date(2025, 9, 5), time: '7:30 PM', platforms: ['instagram','facebook'], status: 'scheduled', media: 'image', title: 'Autumn Prime Cuts' },
					{ date: new Date(2025, 9, 12), time: '8:00 PM', platforms: ['youtube'], status: 'scheduled', media: 'video', title: 'Holiday Menu Preview' },
					{ date: new Date(2025, 9, 19), time: '6:30 PM', platforms: ['tiktok','instagram'], status: 'scheduled', media: 'video', title: 'Steakhouse Secrets' },
					{ date: new Date(2025, 9, 26), time: '7:00 PM', platforms: ['facebook'], status: 'scheduled', media: 'image', title: 'Premium Dining Experience' }
				]
			}
		};

		// Content lists data
		const CONTENT_LISTS = {
            'my-videos': {
                name: 'My Videos',
                icon: '🎥',
                type: 'system',
                items: [
                    { id: 'v1', title: 'Summer Burger Sizzle', thumbnail: '🍔', type: 'Video', duration: '0:45', created: 'August 15, 2025', source: 'Presence AI', gradClass: 'grad-blur-1', liked: true },
                    { id: 'v2', title: 'Behind the Grill', thumbnail: '🔥', type: 'Video', duration: '1:20', created: 'August 12, 2025', source: 'User Upload', gradClass: 'grad-blur-2' },
                    { id: 'v3', title: 'Happy Hour Vibes', thumbnail: '🍺', type: 'Video', duration: '0:30', created: 'August 10, 2025', source: 'Presence AI', gradClass: 'grad-blur-3' }
                ]
            },
            'my-images': {
                name: 'My Images',
                icon: '🖼️',
                type: 'system',
                items: [
                    { id: 'i1', title: 'Fresh Ingredients', thumbnail: '🥬', type: 'Image', duration: 'N/A', created: 'August 18, 2025', source: 'User Upload', gradClass: 'grad-blur-4'},
                    { id: 'i2', title: 'Menu Showcase', thumbnail: '📋', type: 'Image', duration: 'N/A', created: 'August 16, 2025', source: 'Presence AI', gradClass: 'grad-blur-5' }
                ]
            },
            'creators': {
                name: 'Made by Creators',
                icon: '👥',
                type: 'system',
                items: [
                    { id: 'c1', title: 'Customer Review #1', thumbnail: '⭐', type: 'Video', duration: '0:55', created: 'August 14, 2025', source: 'Creator Network', gradClass: 'grad-blur-6', liked: true },
                    { id: 'c2', title: 'Food Challenge', thumbnail: '🏆', type: 'Video', duration: '2:10', created: 'August 8, 2025', source: 'Creator Network', gradClass: 'grad-blur-7' , liked: true },
                    { id: 'c3', title: 'Unboxing Special', thumbnail: '📦', type: 'Video', duration: '1:30', created: 'August 5, 2025', source: 'Creator Network', gradClass: 'grad-blur-8' },
                    { id: 'c4', title: 'Taste Test', thumbnail: '😋', type: 'Video', duration: '1:45', created: 'August 3, 2025', source: 'Creator Network', gradClass: 'grad-blur-1' }
                ]
            },
            'producer': {
                name: 'Made by Producer Mode',
                icon: '🎬',
                type: 'system',
                items: [
                    { id: 'p1', title: 'Weekly Special Promo', thumbnail: '🎯', type: 'Video', duration: '0:40', created: 'August 17, 2025', source: 'Producer Mode', gradClass: 'grad-blur-2', liked: true },
                    { id: 'p2', title: 'Brand Story', thumbnail: '📖', type: 'Video', duration: '1:50', created: 'August 11, 2025', source: 'Producer Mode', gradClass: 'grad-blur-3' }
                ]
            },
            'menu-project': {
                name: 'New Menu Awareness Project',
                icon: '📋',
                type: 'custom',
                items: [
                    { id: 'm1', title: 'New Menu Launch', thumbnail: '🎉', type: 'Video', duration: '0:50', created: 'August 19, 2025', source: 'Presence AI', gradClass: 'grad-blur-4'},
                    { id: 'm2', title: 'Seasonal Items', thumbnail: '🍂', type: 'Image', duration: 'N/A', created: 'August 18, 2025', source: 'User Upload', gradClass: 'grad-blur-5' },
                    { id: 'm3', title: 'Chef Recommendations', thumbnail: '👨‍🍳', type: 'Video', duration: '1:15', created: 'August 16, 2025', source: 'Presence AI', gradClass: 'grad-blur-6' }
                ]
            },
            'summer-campaign': {
                name: 'Summer Campaign',
                icon: '☀️',
                type: 'custom',
                items: [
                    { id: 'sc1', title: 'Beach Vibes Menu', thumbnail: '🏖️', type: 'Video', duration: '0:35', created: 'July 25, 2025', source: 'Presence AI', gradClass: 'grad-blur-7', liked: true },
                    { id: 'sc2', title: 'Cool Drinks Special', thumbnail: '🍹', type: 'Video', duration: '0:50', created: 'July 22, 2025', source: 'User Upload', gradClass: 'grad-blur-8', liked: true  },
                    { id: 'sc3', title: 'Outdoor Dining', thumbnail: '🌞', type: 'Image', duration: 'N/A', created: 'July 20, 2025', source: 'Presence AI', gradClass: 'grad-blur-1' }
                ]
            },
            'customer-stories': {
                name: 'Customer Stories',
                icon: '💬',
                type: 'custom',
                items: [
                    { id: 'cs1', title: 'Family Celebration', thumbnail: '👨‍👩‍👧‍👦', type: 'Video', duration: '1:05', created: 'August 5, 2025', source: 'Creator Network', gradClass: 'grad-blur-2', liked: true },
                    { id: 'cs2', title: 'Anniversary Dinner', thumbnail: '💑', type: 'Video', duration: '0:55', created: 'August 2, 2025', source: 'Creator Network', gradClass: 'grad-blur-3' }
                ]
            },
            'recipe-series': {
                name: 'Recipe Series',
                icon: '📖',
                type: 'custom',
                items: [
                    { id: 'rs1', title: 'Secret Sauce Recipe', thumbnail: '🥫', type: 'Video', duration: '2:15', created: 'July 30, 2025', source: 'Producer Mode', gradClass: 'grad-blur-4', liked: true },
                    { id: 'rs2', title: 'Perfect Patty Guide', thumbnail: '🥩', type: 'Video', duration: '1:45', created: 'July 28, 2025', source: 'Producer Mode', gradClass: 'grad-blur-5' },
                    { id: 'rs3', title: 'Homemade Buns', thumbnail: '🍞', type: 'Video', duration: '3:00', created: 'July 25, 2025', source: 'User Upload', gradClass: 'grad-blur-6' }
                ]
            },
            'behind-scenes': {
                name: 'Behind the Scenes',
                icon: '🎭',
                type: 'custom',
                items: [
                    { id: 'bs1', title: 'Morning Prep Routine', thumbnail: '🌅', type: 'Video', duration: '1:30', created: 'August 8, 2025', source: 'User Upload', gradClass: 'grad-blur-7', liked: true },
                    { id: 'bs2', title: 'Meet Our Chef', thumbnail: '👨‍🍳', type: 'Video', duration: '2:00', created: 'August 6, 2025', source: 'Presence AI', gradClass: 'grad-blur-8', liked: true  },
                    { id: 'bs3', title: 'Kitchen Tour', thumbnail: '🏪', type: 'Video', duration: '1:40', created: 'August 4, 2025', source: 'User Upload', gradClass: 'grad-blur-1' },
                    { id: 'bs4', title: 'Team Introduction', thumbnail: '👥', type: 'Video', duration: '1:15', created: 'August 1, 2025', source: 'Presence AI', gradClass: 'grad-blur-2' }
                ]
            }
        };

		let currentBrand = 'MeatBar Burger';
		let currentList = 'my-videos';
		let posts = BRAND_DATA[currentBrand].posts;

        // ===== Calendar rendering =====
		
		function switchBrand(brandName) {
			currentBrand = brandName;
			posts = BRAND_DATA[currentBrand].posts;
			renderCalendar();
		}

        function renderCalendar() {
            const calendarBody = document.getElementById('calendarBody');
            calendarBody.innerHTML = '';

            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

            const todayDate = new Date(today); todayDate.setHours(0,0,0,0);

            // Leading blanks
            for (let i = 0; i < firstDay; i++) calendarBody.appendChild(createEmptyDay());

            // Days
            for (let day = 1; day <= daysInMonth; day++) {
                const dayDate = new Date(currentYear, currentMonth, day); dayDate.setHours(0,0,0,0);
                const isPast = dayDate < todayDate;
                const isToday = dayDate.getTime() === todayDate.getTime();
                const dayElement = createDayElement(day, dayDate, isPast, isToday);

                // Add posts for this day
                const dayPosts = posts.filter(p => {
                    const pd = new Date(p.date);
                    return pd.getDate() === day && pd.getMonth() === currentMonth && pd.getFullYear() === currentYear;
                }).sort((a,b) => a.time.localeCompare(b.time));

				if (dayPosts.length > 2) {
					dayPosts.slice(0, 2).forEach(post => dayElement.appendChild(createPostElement(post)));
					const indicator = document.createElement('div');
					indicator.className = 'overflow-indicator';
					indicator.textContent = `+${dayPosts.length - 2}`;
					dayElement.appendChild(indicator);
				} else {
					dayPosts.forEach(post => dayElement.appendChild(createPostElement(post)));
				}
                calendarBody.appendChild(dayElement);
            }

            setupDragAndDrop();
        }

        function createEmptyDay() { 
            const div = document.createElement('div'); 
            div.className = 'calendar-day'; 
            return div; 
        }
        
        function createDayElement(day, date, isPast, isToday) {
            const div = document.createElement('div');
            div.className = 'calendar-day' + (isPast ? ' past' : '') + (isToday ? ' today' : '');
            div.dataset.date = date.toISOString();
            const dayNumber = document.createElement('div'); 
            dayNumber.className = 'day-number'; 
            dayNumber.textContent = day; 
            div.appendChild(dayNumber);
            return div;
        }
        
        function mediaEmoji(type){ return type === 'video' ? '🎥' : '🖼️'; }
        
        function createPostElement(post) {
            const div = document.createElement('div'); 
            div.className = 'post-item';
            
            const firstLine = document.createElement('div'); 
            firstLine.className = 'post-first-line';
            
            const left = document.createElement('div'); 
            left.className = 'post-left';
            const indicator = document.createElement('div'); 
            indicator.className = `status-indicator ${post.status}`;
            const time = document.createElement('span'); 
            time.className = 'post-time'; 
            time.textContent = post.time;
            const media = document.createElement('span'); 
            media.className = 'media-icon'; 
            media.textContent = mediaEmoji(post.media);
            left.appendChild(indicator); 
            left.appendChild(time); 
            left.appendChild(media);

            const right = document.createElement('div'); 
            right.className = 'post-right';
            (post.platforms || []).forEach(p => {
                const s = document.createElement('span'); 
                s.className = `badge ${PLATFORM_BADGES[p].cls}`; 
                s.textContent = PLATFORM_BADGES[p].label; 
                right.appendChild(s);
            });

            firstLine.appendChild(left); 
            firstLine.appendChild(right);
            
            const titleLine = document.createElement('div'); 
            titleLine.className = 'post-title';
            titleLine.textContent = post.title;
            
            div.appendChild(firstLine);
            div.appendChild(titleLine);
            return div;
        }

        // ===== Month navigation =====
        function changeMonth(direction) {
            currentMonth += direction;
            if (currentMonth > 11) { currentMonth = 0; currentYear++; }
            else if (currentMonth < 0) { currentMonth = 11; currentYear--; }
            updateMonthDisplay(); 
            renderCalendar(); 
            populateMiniCalendar();
        }
        
        function updateMonthDisplay() {
            const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
            document.getElementById('currentMonth').textContent = `${monthNames[currentMonth]} ${currentYear}`;
        }

        // ===== Mini calendar =====
        function toggleMiniCalendar(){ 
            document.getElementById('miniCalendar').classList.toggle('show'); 
        }
        
        function populateMiniCalendar(){
            const grid = document.querySelector('.mini-cal-grid'); 
            grid.innerHTML = '';
            const dayHeaders = ['S','M','T','W','T','F','S'];
            dayHeaders.forEach(d => { 
                const h = document.createElement('div'); 
                h.style.fontWeight = 'bold'; 
                h.style.fontSize = '10px'; 
                h.textContent = d; 
                grid.appendChild(h); 
            });
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            for (let i=0;i<firstDay;i++) grid.appendChild(document.createElement('div'));
            for (let day=1; day<=daysInMonth; day++) {
                const el = document.createElement('div'); 
                el.className='mini-cal-day'; 
                el.textContent = day;
                el.onclick = () => { 
                    document.getElementById('miniCalendar').classList.remove('show'); 
                };
                grid.appendChild(el);
            }
        }

        // ===== Drawer functions + List Selection =====
		
		function updateContentList() {
			const contentList = document.getElementById('contentList');
			contentList.innerHTML = '';
			
			const list = CONTENT_LISTS[currentList];
			if (!list) return;
			
			list.items.forEach(item => {
				const card = document.createElement('div');
				card.className = 'content-card';
				card.setAttribute('draggable', 'true');
				card.setAttribute('data-content', item.id);
				card.setAttribute('data-item', JSON.stringify(item));
				
                card.innerHTML = `
                    <div class="content-thumbnail ${item.gradClass || 'grad-blur-1'}">
                        <div class="content-title">${item.title}</div>
                    </div>
                    ${item.liked ? '<div class="like-badge">❤️</div>' : ''}
                `;
				
				card.onclick = (e) => {
					if (!card.classList.contains('dragging')) {
                        openModal(item);
					}
				};
				
				contentList.appendChild(card);
			});
			
			setupDragAndDrop();
		}
		
        function toggleDrawer(){ 
            // During content-picking, drawer collapse is disabled
            if (contentPickingMode) return;
            document.getElementById('contentDrawer').classList.toggle('open'); 
        }
        
        function selectList(btn) {
            document.querySelectorAll('.list-pill').forEach(p => p.classList.remove('active'));
            btn.classList.add('active');
            currentList = btn.dataset.list;
            updateContentList();
        }
        
        function applyFilters(){
            const q = (document.getElementById('searchInput').value || '').toLowerCase();
            const cards = document.querySelectorAll('.content-card');
            cards.forEach(c => {
                const title = (c.querySelector('.content-title')?.textContent || '').toLowerCase();
                const show = !q || title.includes(q);
                c.style.display = show ? '' : 'none';
            });
        }

        // ===== Modal functions =====
        function openModal(item) {
            const modal = document.getElementById('contentModal');
            document.getElementById('modalTitle').textContent = item.title;
            document.getElementById('modalType').textContent = item.type;
            document.getElementById('modalDuration').textContent = item.duration;
            document.getElementById('modalFormat').textContent = '9:16 (Vertical)';
            document.getElementById('modalCreated').textContent = item.created;
            document.getElementById('modalSource').textContent = item.source;
            document.getElementById('modalStatus').textContent = 'Ready to Publish';
            modal.classList.add('show');
        }

        function closeModal(event) {
            if (!event || event.target.id === 'contentModal' || event.target.classList.contains('modal-close')) {
                document.getElementById('contentModal').classList.remove('show');
            }
        }

        // ===== Create dropdown =====
        function toggleCreateDropdown(){ 
            document.getElementById('createDropdown').classList.toggle('show'); 
        }
        
        function createPost(type){ 
            if (type === 'ai') { alert('AI Series feature coming soon!'); }
            else { alert(`Creating ${type}...`); }
            toggleCreateDropdown(); 
        }

        // ===== New Story Modal State =====
        const nsmState = {
            selectedDate: new Date(2026, 1, 3), // Feb 3 2026 (demo default)
            dpViewMonth: 1,  // Feb
            dpViewYear: 2026,
            selectedPlatforms: new Set(['instagram']),
            selectedContent: null,
            repeatOption: 'Does not repeat',
            timezone: 'UTC',
            selectedHour: 4,    // 1–12
            selectedMin: 0,     // 0, 15, 30, 45
            selectedPeriod: 'PM' // AM / PM
        };

        // ===== Open / Close New Story Modal =====
        function openNewStoryModal(preselectedContent, preselectedDate) {
            document.getElementById('createDropdown').classList.remove('show');
            
            // Reset state
            nsmState.selectedPlatforms = [];
            nsmState.repeatOption = 'Does not repeat';
            nsmState.selectedContent = preselectedContent || null;
            document.getElementById('nsmTitle').value = '';
            nsmState.selectedHour = 4;
            nsmState.selectedMin = 0;
            nsmState.selectedPeriod = 'PM';

            // Set date
            if (preselectedDate) {
                nsmState.selectedDate = new Date(preselectedDate);
            } else {
                nsmState.selectedDate = new Date(2026, 1, 3);
            }
            nsmState.dpViewMonth = nsmState.selectedDate.getMonth();
            nsmState.dpViewYear = nsmState.selectedDate.getFullYear();

            updateNsmDateLabel();
            updateRepeatLabels();
            renderNsmDatepicker();
            renderNsmPlatformSections();
            updateNsmScheduleBtn();
            renderNsmContent();
            updateTimeLabel();
            buildTimeWheels();

            // Close My Content drawer if open
            document.getElementById('contentDrawer').classList.remove('open');

            // Show overlay + modal
            document.getElementById('storyOverlay').classList.add('active');
            document.getElementById('newStoryModal').classList.add('active');
            
            // Focus title input so user can start typing immediately
            setTimeout(() => document.getElementById('nsmTitle').focus(), 50);
        }

        function closeNewStoryModal() {
            document.getElementById('storyOverlay').classList.remove('active');
            document.getElementById('contentPickOverlay').classList.remove('active');
            document.getElementById('newStoryModal').classList.remove('active');
            document.getElementById('contentDrawer').classList.remove('nsm-picking');
            cleanupContentPicking();
            contentPickTarget = null;
            contentPickingMode = false;
            document.querySelectorAll('.nsm-datepicker, .nsm-repeat-dropdown, .nsm-tz-popover').forEach(el => el.classList.remove('show'));
        }

        function saveStoryAsDraft() {
            const title = document.getElementById('nsmTitle').value || 'Untitled Story';
            closeNewStoryModal();
            showToast(`"${title}" saved as draft`);
        }

        function handleOverlayClick() {
            if (contentPickTarget) {
                cancelContentPicking();
            } else {
                saveStoryAsDraft();
            }
        }

        // Exit content-picking mode without choosing content, return to modal
        function cancelContentPicking() {
            contentPickingMode = false;
            document.getElementById('contentPickOverlay').classList.remove('active');
            document.getElementById('contentDrawer').classList.remove('nsm-picking');
            document.getElementById('contentDrawer').classList.remove('open');
        }

        function scheduleStory() {
            const title = document.getElementById('nsmTitle').value || 'Untitled Story';
            const platCount = nsmState.selectedPlatforms.length;
            closeNewStoryModal();
            showToast(`${platCount > 1 ? platCount + ' Stories' : 'Story'} "${title}" scheduled!`);
        }

        // Simple toast notification for demo
        function showToast(msg) {
            let toast = document.getElementById('nsmToast');
            if (!toast) {
                toast = document.createElement('div');
                toast.id = 'nsmToast';
                Object.assign(toast.style, {
                    position: 'fixed', bottom: '80px', left: '50%', transform: 'translateX(-50%)',
                    background: 'var(--text)', color: '#fff', padding: '12px 24px',
                    borderRadius: '10px', fontSize: '14px', fontWeight: '600',
                    boxShadow: '0 8px 24px rgba(0,0,0,.25)', zIndex: '3000',
                    opacity: '0', transition: 'opacity .3s ease', pointerEvents: 'none'
                });
                document.body.appendChild(toast);
            }
            toast.textContent = msg;
            toast.style.opacity = '1';
            setTimeout(() => { toast.style.opacity = '0'; }, 2200);
        }

        // ===== Date handling =====
        function updateNsmDateLabel() {
            const d = nsmState.selectedDate;
            const days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
            const months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
            document.getElementById('nsmDateLabel').textContent = `${days[d.getDay()]}, ${months[d.getMonth()]} ${d.getDate()}`;
        }

        function updateRepeatLabels() {
            const d = nsmState.selectedDate;
            const days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
            const months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
            const dayName = days[d.getDay()];
            
            // Weekly label
            document.getElementById('nsmRepeatWeekly').innerHTML = `Weekly on ${dayName}`;
            
            // Monthly label — compute ordinal weekday
            const weekNum = Math.ceil(d.getDate() / 7);
            const ordinals = ['first','second','third','fourth','fifth'];
            document.getElementById('nsmRepeatMonthly').innerHTML = `Monthly on the ${ordinals[weekNum-1]} ${dayName}`;
            
            // Annually label
            document.getElementById('nsmRepeatAnnually').innerHTML = `Annually on ${months[d.getMonth()]} ${d.getDate()}`;
        }

        function toggleNsmDatepicker(e) {
            e.stopPropagation();
            const dp = document.getElementById('nsmDatepicker');
            const wasOpen = dp.classList.contains('show');
            closeAllNsmPopovers();
            if (!wasOpen) { dp.classList.add('show'); renderNsmDatepicker(); }
        }

        function nsmDpNav(dir) {
            nsmState.dpViewMonth += dir;
            if (nsmState.dpViewMonth > 11) { nsmState.dpViewMonth = 0; nsmState.dpViewYear++; }
            else if (nsmState.dpViewMonth < 0) { nsmState.dpViewMonth = 11; nsmState.dpViewYear--; }
            renderNsmDatepicker();
        }

        function renderNsmDatepicker() {
            const months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
            document.getElementById('nsmDpTitle').textContent = `${months[nsmState.dpViewMonth]} ${nsmState.dpViewYear}`;
            
            const grid = document.getElementById('nsmDpGrid');
            grid.innerHTML = '';
            
            ['S','M','T','W','T','F','S'].forEach(h => {
                const hd = document.createElement('div');
                hd.className = 'dp-header';
                hd.textContent = h;
                grid.appendChild(hd);
            });
            
            const firstDay = new Date(nsmState.dpViewYear, nsmState.dpViewMonth, 1).getDay();
            const daysInMonth = new Date(nsmState.dpViewYear, nsmState.dpViewMonth + 1, 0).getDate();
            const daysInPrevMonth = new Date(nsmState.dpViewYear, nsmState.dpViewMonth, 0).getDate();
            
            // Previous month trailing days
            for (let i = firstDay - 1; i >= 0; i--) {
                const btn = document.createElement('button');
                btn.className = 'nsm-dp-day other-month';
                btn.textContent = daysInPrevMonth - i;
                grid.appendChild(btn);
            }
            
            // Current month
            const todayRef = new Date(); todayRef.setHours(0,0,0,0);
            for (let day = 1; day <= daysInMonth; day++) {
                const btn = document.createElement('button');
                btn.className = 'nsm-dp-day';
                btn.textContent = day;
                
                const thisDate = new Date(nsmState.dpViewYear, nsmState.dpViewMonth, day);
                if (thisDate.getTime() === todayRef.getTime()) btn.classList.add('today');
                if (nsmState.selectedDate.getDate() === day && 
                    nsmState.selectedDate.getMonth() === nsmState.dpViewMonth &&
                    nsmState.selectedDate.getFullYear() === nsmState.dpViewYear) {
                    btn.classList.add('selected');
                }
                
                btn.onclick = () => {
                    nsmState.selectedDate = new Date(nsmState.dpViewYear, nsmState.dpViewMonth, day);
                    updateNsmDateLabel();
                    updateRepeatLabels();
                    renderNsmDatepicker();
                    document.getElementById('nsmDatepicker').classList.remove('show');
                };
                grid.appendChild(btn);
            }
            
            // Next month leading days
            const totalCells = firstDay + daysInMonth;
            const remaining = (7 - (totalCells % 7)) % 7;
            for (let i = 1; i <= remaining; i++) {
                const btn = document.createElement('button');
                btn.className = 'nsm-dp-day other-month';
                btn.textContent = i;
                grid.appendChild(btn);
            }
        }

        // ===== Timezone =====
        // Timezone settings — coming soon (placeholder alert on click)

        // ===== Repeat =====
        function toggleNsmRepeat(e) {
            e.stopPropagation();
            const dd = document.getElementById('nsmRepeatDropdown');
            const wasOpen = dd.classList.contains('show');
            closeAllNsmPopovers();
            if (!wasOpen) dd.classList.add('show');
        }

        function selectRepeat(btn, label) {
            const text = label || btn.textContent;
            document.querySelectorAll('.nsm-repeat-option').forEach(o => o.classList.remove('active'));
            btn.classList.add('active');
            nsmState.repeatOption = text;
            document.getElementById('nsmRepeatLabel').textContent = text;
            document.getElementById('nsmRepeatDropdown').classList.remove('show');
            if (text === 'Custom...') {
                alert('Custom repeat configuration coming soon!');
            }
        }

        // ===== Platforms (Story) — uses same visual style as Post but no expand/collapse =====
        const STORY_PLATFORM_ORDER = ['instagram', 'facebook'];

        function toggleNsmPlatform(plat) {
            const section = document.querySelector(`#nsmPlatformSections .npm-plat-section[data-plat="${plat}"]`);
            if (!section) { renderNsmPlatformSections(); return; }

            const idx = nsmState.selectedPlatforms.indexOf(plat);
            if (idx !== -1) {
                nsmState.selectedPlatforms.splice(idx, 1);
                section.classList.remove('selected');
            } else {
                nsmState.selectedPlatforms.push(plat);
                section.classList.add('selected');
            }
            updateNsmScheduleBtn();
        }

        function renderNsmPlatformSections() {
            const container = document.getElementById('nsmPlatformSections');
            if (!container) return;
            container.innerHTML = '';

            STORY_PLATFORM_ORDER.forEach(plat => {
                const cfg = PLATFORM_CONFIG[plat];
                const isSelected = nsmState.selectedPlatforms.includes(plat);

                const section = document.createElement('div');
                section.className = `npm-plat-section collapsed${isSelected ? ' selected' : ''}`;
                section.dataset.plat = plat;

                const header = document.createElement('div');
                header.className = 'npm-plat-header';
                header.innerHTML = `
                    <div class="npm-plat-header-left">
                        <div class="npm-plat-toggle" data-plat="${plat}">
                            <span class="npm-plat-toggle-check">✓</span>
                        </div>
                        <div class="npm-account-thumb">
                            ${cfg.brandIcon}
                            <span class="npm-account-badge ${cfg.cls}">${cfg.label}</span>
                        </div>
                        <div class="npm-plat-info">
                            <span class="npm-plat-name">${cfg.name}</span>
                            <span class="npm-plat-username">${cfg.username}</span>
                        </div>
                    </div>
                `;

                // Clicking anywhere on the header toggles selection
                header.onclick = () => toggleNsmPlatform(plat);
                section.appendChild(header);
                container.appendChild(section);
            });
        }

        function updateNsmScheduleBtn() {
            const btn = document.getElementById('nsmScheduleBtn');
            const hasContent = nsmState.selectedContent !== null;
            const hasPlatform = nsmState.selectedPlatforms.length > 0;
            btn.disabled = !(hasContent && hasPlatform);
        }

        function updateNsmState() { /* placeholder for future reactivity */ }

        // ===== iPhone-inspired scroll-wheel time picker =====
        const NTP_ITEM_H = 36;    // height of each wheel item
        const NTP_SPACER_H = 72;  // padding (2 items) at top/bottom
        const NTP_HOURS = [1,2,3,4,5,6,7,8,9,10,11,12];
        const NTP_MINS = Array.from({length: 60}, (_, i) => i); // 0–59, 1-minute intervals
        const NTP_PERIODS = ['AM','PM'];
        
        function toggleTimePicker(e) {
            e.stopPropagation();
            const picker = document.getElementById('nsmTimePicker');
            const wasOpen = picker.classList.contains('show');
            closeAllNsmPopovers();
            if (!wasOpen) { 
                picker.classList.add('show'); 
                buildTimeWheels();
            }
        }

        function buildTimeWheels() {
            buildWheelCol('ntpHourWheel', NTP_HOURS, nsmState.selectedHour, v => String(v), val => {
                nsmState.selectedHour = val;
                updateTimeLabel();
            });
            buildWheelCol('ntpMinWheel', NTP_MINS, nsmState.selectedMin, v => String(v).padStart(2,'0'), val => {
                nsmState.selectedMin = val;
                updateTimeLabel();
            });
            buildWheelCol('ntpPeriodWheel', NTP_PERIODS, nsmState.selectedPeriod, v => v, val => {
                nsmState.selectedPeriod = val;
                updateTimeLabel();
            });
        }

        function buildWheelCol(containerId, values, selectedVal, formatFn, onSelect) {
            const col = document.getElementById(containerId);
            col.innerHTML = '';
            
            // Top spacer
            const topSpacer = document.createElement('div');
            topSpacer.className = 'ntp-wheel-spacer';
            col.appendChild(topSpacer);
            
            // Items
            values.forEach(val => {
                const item = document.createElement('button');
                item.className = 'ntp-wheel-item';
                item.dataset.val = val;
                item.textContent = formatFn(val);
                item.onclick = (e) => {
                    e.stopPropagation();
                    onSelect(val);
                    // Smooth scroll to clicked item
                    const idx = values.indexOf(val);
                    col.scrollTo({ top: idx * NTP_ITEM_H, behavior: 'smooth' });
                    updateWheelHighlights(col, values, val);
                };
                col.appendChild(item);
            });
            
            // Bottom spacer
            const bottomSpacer = document.createElement('div');
            bottomSpacer.className = 'ntp-wheel-spacer';
            col.appendChild(bottomSpacer);
            
            // Scroll to selected
            const selectedIdx = values.indexOf(selectedVal);
            col.scrollTop = selectedIdx * NTP_ITEM_H;
            updateWheelHighlights(col, values, selectedVal);
            
            // Scroll listener for snap-based selection
            let scrollTimer = null;
            col.addEventListener('scroll', () => {
                clearTimeout(scrollTimer);
                scrollTimer = setTimeout(() => {
                    const idx = Math.round(col.scrollTop / NTP_ITEM_H);
                    const clampedIdx = Math.max(0, Math.min(idx, values.length - 1));
                    const newVal = values[clampedIdx];
                    onSelect(newVal);
                    updateWheelHighlights(col, values, newVal);
                }, 80);
            }, { passive: true });
        }
        
        function updateWheelHighlights(col, values, selectedVal) {
            const items = col.querySelectorAll('.ntp-wheel-item');
            items.forEach(item => {
                const val = item.dataset.val;
                // Coerce for comparison (numbers vs strings)
                const isSelected = String(val) === String(selectedVal);
                item.classList.toggle('in-view', isSelected);
            });
        }

        function updateTimeLabel() {
            const label = `${nsmState.selectedHour}:${String(nsmState.selectedMin).padStart(2, '0')} ${nsmState.selectedPeriod}`;
            document.getElementById('nsmTimeLabel').textContent = label;
        }

        // ===== Content picker =====
        function openContentPicker() {
            openUnifiedContentPicker('story');
        }

        // ===== Unified content picking mode =====
        let contentPickTarget = null; // 'story' | 'post' | null

        /**
         * Content Picking: Clone Approach
         * 
         * ANALYSIS: The content preview sits inside .npm-body-scroll (overflow-y: auto)
         * which is inside the modal (position: fixed, z-index: 1600). The global dark
         * overlay is at z-index: 1650, above the modal. No child of the modal can
         * escape its parent's stacking context.
         *
         * Previous attempt: Setting position:fixed on the preview. This failed because:
         * 1. The overflow:auto parent clips fixed children in many rendering paths
         * 2. When the element leaves normal flow, the parent collapses
         * 3. Stacking context of the modal (z-index:1600) still caps the child
         *
         * SOLUTION: Create a visual clone of the preview, append it to <body> at the
         * same screen position with z-index above the overlay. Hide the original.
         * On cleanup, remove clone and restore original visibility.
         */
        let pickClone = null; // The floating clone element
        let pickGlow = null;  // Separate glow element behind the clone
        const CLONE_BG = '#f8f7fc';       // opaque light purple tint
        const CLONE_BG_HOVER = '#f0ecf7'; // opaque deeper tint for drag-over

        function openUnifiedContentPicker(target) {
            if (contentPickTarget) return;
            contentPickTarget = target;
            contentPickingMode = true;

            const previewId = target === 'story' ? 'nsmContentPreview' : 'npmContentPreview';
            const preview = document.getElementById(previewId);
            const rect = preview.getBoundingClientRect();

            // Hide the original (keeps its space via visibility)
            preview.style.visibility = 'hidden';

            // Create a glow element BEHIND the clone.
            // box-shadow renders against the dark overlay and looks muted.
            // Instead, a separate div with an opaque radial gradient provides a vivid glow.
            const glowPad = 28; // how far the glow extends beyond the clone
            pickGlow = document.createElement('div');
            pickGlow.id = 'pickGlow';
            pickGlow.style.cssText = `
                position: fixed;
                top: ${rect.top - glowPad}px;
                left: ${rect.left - glowPad}px;
                width: ${rect.width + glowPad * 2}px;
                height: ${rect.height + glowPad * 2}px;
                z-index: 1659;
                pointer-events: none;
                border-radius: ${14 + glowPad}px;
                background: radial-gradient(ellipse at center,
                    rgba(251, 191, 36, .45) 0%,
                    rgba(251, 191, 36, .25) 40%,
                    rgba(251, 191, 36, .08) 70%,
                    transparent 100%);
            `;
            document.body.appendChild(pickGlow);

            // Create a visual clone positioned above everything
            // CRITICAL: backgrounds must be OPAQUE — the clone sits above the dark overlay,
            // so any transparency lets the darkness bleed through.
            pickClone = preview.cloneNode(true);
            pickClone.id = 'pickClone';
            pickClone.removeAttribute('onclick');
            pickClone.style.cssText = `
                position: fixed;
                top: ${rect.top}px;
                left: ${rect.left}px;
                width: ${rect.width}px;
                height: ${rect.height}px;
                z-index: 1660;
                pointer-events: auto;
                margin: 0;
                border-color: var(--color-primary);
                background: ${CLONE_BG};
                border-radius: 14px;
                border-width: 2px;
                border-style: dashed;
                display: flex; flex-direction: column;
                align-items: center; justify-content: center;
                overflow: hidden;
            `;
            // Prevent child elements from stealing drag events (causes flickering)
            pickClone.querySelectorAll('*').forEach(child => {
                child.style.pointerEvents = 'none';
            });
            document.body.appendChild(pickClone);

            // Set up drag-and-drop on the clone — no flickering since children have pointer-events:none
            pickClone.addEventListener('dragover', e => {
                e.preventDefault(); e.stopPropagation();
                e.dataTransfer.dropEffect = 'copy';
                pickClone.style.borderStyle = 'solid';
                pickClone.style.background = CLONE_BG_HOVER;
            });
            pickClone.addEventListener('dragleave', e => {
                e.stopPropagation();
                // Only revert if cursor truly left the clone (not just moved to a child)
                if (e.relatedTarget && pickClone.contains(e.relatedTarget)) return;
                pickClone.style.borderStyle = 'dashed';
                pickClone.style.background = CLONE_BG;
            });
            pickClone.addEventListener('drop', e => {
                e.preventDefault(); e.stopPropagation();
                let item = null;
                try { item = JSON.parse(e.dataTransfer.getData('item')); } catch(err) {}
                if (item) {
                    if (contentPickTarget === 'post') pickContentForPost(item);
                    else if (contentPickTarget === 'story') pickContentForStory(item);
                }
            });

            // Show overlay and open drawer
            document.getElementById('contentPickOverlay').classList.add('active');
            const drawer = document.getElementById('contentDrawer');
            drawer.classList.add('nsm-picking');
            drawer.classList.add('open');
        }

        function cancelContentPicking() {
            contentPickTarget = null;
            contentPickingMode = false;
            document.getElementById('contentPickOverlay').classList.remove('active');
            document.getElementById('contentDrawer').classList.remove('nsm-picking');
            document.getElementById('contentDrawer').classList.remove('open');
            cleanupContentPicking();
        }

        // Shared cleanup — remove clone, glow, and restore original
        function cleanupContentPicking() {
            if (pickClone) {
                pickClone.remove();
                pickClone = null;
            }
            if (pickGlow) {
                pickGlow.remove();
                pickGlow = null;
            }
            ['nsmContentPreview', 'npmContentPreview'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.style.visibility = '';
                    el.classList.remove('pick-elevated');
                }
            });
        }

        // Legacy bridge — contentPickingMode is still checked in card click handlers
        let contentPickingMode = false;
        function enableContentPickingMode() {
            contentPickingMode = true;
        }

        function pickContentForStory(item) {
            nsmState.selectedContent = item;
            contentPickTarget = null;
            contentPickingMode = false;
            
            document.getElementById('contentPickOverlay').classList.remove('active');
            document.getElementById('contentDrawer').classList.remove('nsm-picking');
            document.getElementById('contentDrawer').classList.remove('open');
            cleanupContentPicking();
            
            renderNsmContent();
        }

        function renderNsmContent() {
            const placeholder = document.getElementById('nsmPlaceholder');
            const filled = document.getElementById('nsmContentFilled');
            const removeBtn = document.getElementById('nsmRemoveContent');
            const preview = document.getElementById('nsmContentPreview');
            
            if (nsmState.selectedContent) {
                placeholder.style.display = 'none';
                filled.style.display = 'flex';
                removeBtn.style.display = 'flex';
                preview.classList.add('has-content');
                filled.className = `nsm-content-filled ${nsmState.selectedContent.gradClass || 'grad-blur-1'}`;
                filled.innerHTML = `<div class="filled-title">${nsmState.selectedContent.title}</div>`;
            } else {
                placeholder.style.display = 'flex';
                filled.style.display = 'none';
                removeBtn.style.display = 'none';
                preview.classList.remove('has-content');
            }
        }

        function removeStoryContent(e) {
            e.stopPropagation();
            nsmState.selectedContent = null;
            renderNsmContent();
        }

        // ===== Drag & drop onto content preview in modal =====
        // ONLY accepts drops within the modal bounds, not anywhere on the darkened overlay
        function setupContentPreviewDrop() {
            const preview = document.getElementById('nsmContentPreview');
            const overlay = document.getElementById('contentPickOverlay');
            const modal = document.querySelector('.new-story-modal');
            
            // Direct drop on content preview (when modal not behind overlay)
            preview.addEventListener('dragover', e => {
                e.preventDefault();
                e.stopPropagation();
                e.dataTransfer.dropEffect = 'copy';
                preview.classList.add('drop-hover');
            });
            preview.addEventListener('dragleave', e => {
                e.stopPropagation();
                preview.classList.remove('drop-hover');
            });
            preview.addEventListener('drop', e => {
                e.preventDefault();
                e.stopPropagation();
                preview.classList.remove('drop-hover');
                handleContentDrop(e);
            });
            
            // Proxy drop on overlay — during picking mode, check if over the clone
            overlay.addEventListener('dragover', e => {
                if (!contentPickingMode) return;
                if (!pickClone) return;
                
                const cloneRect = pickClone.getBoundingClientRect();
                const isOnClone = e.clientX >= cloneRect.left && e.clientX <= cloneRect.right && 
                                 e.clientY >= cloneRect.top && e.clientY <= cloneRect.bottom;
                
                if (isOnClone) {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'copy';
                    pickClone.style.borderStyle = 'solid';
                    pickClone.style.background = CLONE_BG_HOVER;
                } else {
                    e.dataTransfer.dropEffect = 'none';
                    pickClone.style.borderStyle = 'dashed';
                    pickClone.style.background = CLONE_BG;
                }
            });
            overlay.addEventListener('dragleave', e => {
                if (!contentPickingMode || !pickClone) return;
                pickClone.style.borderStyle = 'dashed';
                pickClone.style.background = CLONE_BG;
            });
            overlay.addEventListener('drop', e => {
                if (!contentPickingMode || !pickClone) return;
                
                const cloneRect = pickClone.getBoundingClientRect();
                const isOnClone = e.clientX >= cloneRect.left && e.clientX <= cloneRect.right && 
                                 e.clientY >= cloneRect.top && e.clientY <= cloneRect.bottom;
                
                if (isOnClone) {
                    e.preventDefault();
                    handleContentDrop(e);
                }
            });
        }
        
        // Shared handler: parse dropped content and pick it for the story
        function handleContentDrop(e) {
            let item = null;
            try { item = JSON.parse(e.dataTransfer.getData('item')); } catch(err) {}
            
            if (item) {
                if (contentPickingMode) {
                    // Exit picking mode and close drawer
                    pickContentForStory(item);
                } else {
                    // Direct drop on modal (drawer not in picking mode)
                    nsmState.selectedContent = item;
                    renderNsmContent();
                }
            }
        }

        // Close all sub-popovers inside modal
        function closeAllNsmPopovers() {
            document.querySelectorAll('.nsm-datepicker, .nsm-repeat-dropdown, .nsm-tz-popover, .nsm-time-picker').forEach(el => el.classList.remove('show'));
        }

        // ===== Drag & Drop — enhanced with type picker =====
        let dragDropData = { content: null, date: null, x: 0, y: 0 };

        function setupDragAndDrop(){
            const cards = document.querySelectorAll('.content-card');
            const days = document.querySelectorAll('.calendar-day');
            cards.forEach(card => {
                card.addEventListener('dragstart', e => { 
                    e.dataTransfer.effectAllowed = 'copy'; 
                    e.dataTransfer.setData('content', card.dataset.content);
                    e.dataTransfer.setData('item', card.dataset.item || '');
                    card.classList.add('dragging'); 
                });
                card.addEventListener('dragend', () => card.classList.remove('dragging'));
            });
            days.forEach(day => {
                day.addEventListener('dragover', e => { 
                    e.preventDefault(); 
                    e.dataTransfer.dropEffect = 'copy'; 
                    day.classList.add('drag-over'); 
                });
                day.addEventListener('dragleave', () => day.classList.remove('drag-over'));
                day.addEventListener('drop', e => { 
                    e.preventDefault(); 
                    day.classList.remove('drag-over');
                    
                    const contentId = e.dataTransfer.getData('content');
                    let item = null;
                    try { item = JSON.parse(e.dataTransfer.getData('item')); } catch(err) {}
                    const date = day.dataset.date ? new Date(day.dataset.date) : null;
                    
                    // Store for type picker
                    dragDropData = { content: item, date: date, x: e.clientX, y: e.clientY };
                    
                    // Show type picker at drop location
                    const picker = document.getElementById('dragTypePicker');
                    picker.style.left = e.clientX + 'px';
                    picker.style.top = e.clientY + 'px';
                    picker.classList.add('show');
                });
            });
        }

        function dragCreatePost() {
            document.getElementById('dragTypePicker').classList.remove('show');
            openNewPostModal(dragDropData.content, dragDropData.date);
        }

        function dragCreateStory() {
            document.getElementById('dragTypePicker').classList.remove('show');
            openNewStoryModal(dragDropData.content, dragDropData.date);
        }

        // ===== View toggle =====
        function switchView(view){ 
            const btns = document.querySelectorAll('.view-btn'); 
            if (view === 'list'){ 
                alert('List view coming soon!'); 
                return; 
            } 
            btns.forEach(b=>b.classList.remove('active')); 
            event.target.classList.add('active'); 
        }

        // ===== Click-away close for dropdowns =====
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.create-button')) document.getElementById('createDropdown').classList.remove('show');
            if (!e.target.closest('.month-year-display')) document.getElementById('miniCalendar').classList.remove('show');
            if (!e.target.closest('.drag-type-picker')) document.getElementById('dragTypePicker').classList.remove('show');
            // Close nsm sub-popovers when clicking inside modal but outside the popover
            if (e.target.closest('.new-story-modal') && !e.target.closest('.nsm-chip') && !e.target.closest('.nsm-datepicker') && !e.target.closest('.nsm-repeat-dropdown') && !e.target.closest('.nsm-tz-popover') && !e.target.closest('.nsm-time-picker')) {
                closeAllNsmPopovers();
            }
        });

        // ===== Brand dropdown functions =====
        const selector = document.querySelector('.tenant-brand-selector');
        const dropdown = document.getElementById('brandDropdown');
        const tenantName = selector.querySelector('.tenant-name');
        const brandIcon = selector.querySelector('.brand-icon');

        function toggleBrandDropdown(e){
            e && e.stopPropagation();
            const isOpen = dropdown.classList.toggle('open');
            selector.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
            if (isOpen){
                const first = dropdown.querySelector('.brand-option:not(.add-brand)');
                first && first.focus();
                document.addEventListener('click', onClickOutside);
                document.addEventListener('keydown', onGlobalEscape);
            } else {
                cleanupDropdownListeners();
            }
        }

        function onClickOutside(ev){ if(!selector.contains(ev.target)) closeDropdown(); }
        function onGlobalEscape(ev){ if(ev.key==='Escape') closeDropdown(); }

        function closeDropdown(){
            dropdown.classList.remove('open');
            selector.setAttribute('aria-expanded','false');
            cleanupDropdownListeners();
        }

        function cleanupDropdownListeners(){
            document.removeEventListener('click', onClickOutside);
            document.removeEventListener('keydown', onGlobalEscape);
        }

        dropdown.addEventListener('click', (ev)=>{
            ev.stopPropagation();
            const option = ev.target.closest('.brand-option');
            if(!option) return;
            
            if(option.dataset.addBrand) {
                alert("Directing the user to the \"New Brand\" page.\nIn case the user's subscription is insufficient - it is directed to the \"Subscription Plans\" page to upgrade its plan.");
                return;
            }
            
            dropdown.querySelectorAll('.brand-option:not(.add-brand)').forEach(opt => opt.classList.remove('active'));
            option.classList.add('active');
            
            const name = option.dataset.brand;
            const icon = option.dataset.icon;
            tenantName.textContent = name;
            brandIcon.textContent = icon;
			switchBrand(name);
            closeDropdown();
        });

        function setInitialActiveState() {
            const currentBrand = tenantName.textContent;
            dropdown.querySelectorAll('.brand-option:not(.add-brand)').forEach(option => {
                if (option.dataset.brand === currentBrand) {
                    option.classList.add('active');
                }
            });
        }

        function handleBrandSelectorKeydown(e){
            if(e.key==='Enter' || e.key===' '){
                e.preventDefault(); 
                toggleBrandDropdown(e);
            } else if(e.key==='ArrowDown'){
                e.preventDefault(); 
                if(!dropdown.classList.contains('open')) toggleBrandDropdown(e);
            }
        }

        dropdown.addEventListener('keydown', (e)=>{
            const items = Array.from(dropdown.querySelectorAll('.brand-option'));
            const idx = items.indexOf(document.activeElement);
            if(e.key==='ArrowDown'){
                e.preventDefault(); items[(idx+1)%items.length].focus();
            } else if(e.key==='ArrowUp'){
                e.preventDefault(); items[(idx-1+items.length)%items.length].focus();
            } else if(e.key==='Enter'){
                e.preventDefault(); document.activeElement.click();
            } else if(e.key==='Escape'){
                closeDropdown(); selector.focus();
            }
        });

        // ===== Init =====
        updateMonthDisplay();
        populateMiniCalendar();
        updateContentList();
        renderCalendar();
        setupContentPreviewDrop();
        
        document.addEventListener('DOMContentLoaded', setInitialActiveState);

        // ===== New Post Modal State =====
        const npmState = {
            selectedDate: new Date(2026, 1, 3),
            dpViewMonth: 1,
            dpViewYear: 2026,
            selectedPlatforms: [],  // Array preserves insertion order
            selectedContent: null,
            repeatOption: 'Does not repeat',
            timezone: 'UTC',
            selectedHour: 4,
            selectedMin: 0,
            selectedPeriod: 'PM',
            // Per-platform data (persists while modal is open)
            platformData: {
                tiktok: {
                    caption: '',
                    privacyLevel: 'Public',
                    disableDuet: false,
                    disableStitch: false,
                    disableComments: false,
                    brandContent: false,
                    brandOrganic: false,
                    aiGenerated: false
                },
                instagram: {
                    caption: '',
                    location: '',
                    userTags: '',
                    shareToFeed: true
                },
                youtube: {
                    title: '',
                    description: '',
                    privacyStatus: 'Public',
                    tags: [],
                    category: '',
                    madeForKids: false,
                    syntheticMedia: false
                },
                facebook: {
                    message: '',
                    link: ''
                }
            }
        };

        // postContentPickingMode is now handled by contentPickTarget === 'post'

        // Platform section collapsed state (persists within session)
        const npmSectionCollapsed = { tiktok: false, instagram: false, youtube: false, facebook: false };

        // ===== Open / Close New Post Modal =====
        function openNewPostModal(preselectedContent, preselectedDate) {
            document.getElementById('createDropdown').classList.remove('show');
            
            // Reset state
            npmState.selectedPlatforms = [];
            npmState.repeatOption = 'Does not repeat';
            npmState.selectedContent = preselectedContent || null;
            document.getElementById('npmTitle').value = '';
            npmState.selectedHour = 4;
            npmState.selectedMin = 0;
            npmState.selectedPeriod = 'PM';

            // Reset platform data
            npmState.platformData = {
                tiktok: { caption: '', privacyLevel: 'Public', disableDuet: false, disableStitch: false, disableComments: false, brandContent: false, brandOrganic: false, aiGenerated: false },
                instagram: { caption: '', location: '', userTags: '', shareToFeed: true },
                youtube: { title: '', description: '', privacyStatus: 'Public', tags: [], category: '', madeForKids: false, syntheticMedia: false },
                facebook: { message: '', link: '' }
            };
            
            // Reset section collapsed state
            Object.keys(npmSectionCollapsed).forEach(k => npmSectionCollapsed[k] = false);

            // Set date
            if (preselectedDate) {
                npmState.selectedDate = new Date(preselectedDate);
            } else {
                npmState.selectedDate = new Date(2026, 1, 3);
            }
            npmState.dpViewMonth = npmState.selectedDate.getMonth();
            npmState.dpViewYear = npmState.selectedDate.getFullYear();

            updateNpmDateLabel();
            updateNpmRepeatLabels();
            renderNpmDatepicker();
            updateNpmScheduleBtn();
            renderNpmContent();
            updateNpmTimeLabel();
            buildNpmTimeWheels();
            renderNpmPlatformSections();

            // Close My Content drawer if open
            document.getElementById('contentDrawer').classList.remove('open');

            // Show overlay + modal
            document.getElementById('postOverlay').classList.add('active');
            document.getElementById('newPostModal').classList.add('active');
            
            setTimeout(() => document.getElementById('npmTitle').focus(), 50);
        }

        function closeNewPostModal() {
            document.getElementById('postOverlay').classList.remove('active');
            document.getElementById('contentPickOverlay').classList.remove('active');
            document.getElementById('newPostModal').classList.remove('active');
            document.getElementById('contentDrawer').classList.remove('nsm-picking');
            cleanupContentPicking();
            contentPickTarget = null;
            closeAllNpmPopovers();
        }

        function savePostAsDraft() {
            const title = document.getElementById('npmTitle').value || 'Untitled Post';
            closeNewPostModal();
            showToast(`"${title}" saved as draft`);
        }

        function handlePostOverlayClick() {
            if (contentPickTarget) {
                cancelContentPicking();
            } else {
                savePostAsDraft();
            }
        }

        function schedulePost() {
            const title = document.getElementById('npmTitle').value || 'Untitled Post';
            const platCount = npmState.selectedPlatforms.length;
            closeNewPostModal();
            showToast(`${platCount > 1 ? platCount + ' Posts' : 'Post'} "${title}" scheduled!`);
        }

        // ===== Date handling (Post) =====
        function updateNpmDateLabel() {
            const d = npmState.selectedDate;
            const days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
            const months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
            document.getElementById('npmDateLabel').textContent = `${days[d.getDay()]}, ${months[d.getMonth()]} ${d.getDate()}`;
        }

        function updateNpmRepeatLabels() {
            const d = npmState.selectedDate;
            const days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
            const months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
            const dayName = days[d.getDay()];
            const el = (id) => document.getElementById(id);
            if (el('npmRepeatWeekly')) el('npmRepeatWeekly').innerHTML = `Weekly on ${dayName}`;
            const weekNum = Math.ceil(d.getDate() / 7);
            const ordinals = ['first','second','third','fourth','fifth'];
            if (el('npmRepeatMonthly')) el('npmRepeatMonthly').innerHTML = `Monthly on the ${ordinals[weekNum-1]} ${dayName}`;
            if (el('npmRepeatAnnually')) el('npmRepeatAnnually').innerHTML = `Annually on ${months[d.getMonth()]} ${d.getDate()}`;
        }

        function toggleNpmDatepicker(e) {
            e.stopPropagation();
            const dp = document.getElementById('npmDatepicker');
            const wasOpen = dp.classList.contains('show');
            closeAllNpmPopovers();
            if (!wasOpen) { dp.classList.add('show'); renderNpmDatepicker(); }
        }

        function npmDpNav(dir) {
            npmState.dpViewMonth += dir;
            if (npmState.dpViewMonth > 11) { npmState.dpViewMonth = 0; npmState.dpViewYear++; }
            else if (npmState.dpViewMonth < 0) { npmState.dpViewMonth = 11; npmState.dpViewYear--; }
            renderNpmDatepicker();
        }

        function renderNpmDatepicker() {
            const months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
            document.getElementById('npmDpTitle').textContent = `${months[npmState.dpViewMonth]} ${npmState.dpViewYear}`;
            const grid = document.getElementById('npmDpGrid');
            grid.innerHTML = '';
            ['S','M','T','W','T','F','S'].forEach(h => {
                const hd = document.createElement('div');
                hd.className = 'dp-header';
                hd.textContent = h;
                grid.appendChild(hd);
            });
            const firstDay = new Date(npmState.dpViewYear, npmState.dpViewMonth, 1).getDay();
            const daysInMonth = new Date(npmState.dpViewYear, npmState.dpViewMonth + 1, 0).getDate();
            const daysInPrevMonth = new Date(npmState.dpViewYear, npmState.dpViewMonth, 0).getDate();
            for (let i = firstDay - 1; i >= 0; i--) {
                const btn = document.createElement('button');
                btn.className = 'nsm-dp-day other-month';
                btn.textContent = daysInPrevMonth - i;
                grid.appendChild(btn);
            }
            const todayRef = new Date(); todayRef.setHours(0,0,0,0);
            for (let day = 1; day <= daysInMonth; day++) {
                const btn = document.createElement('button');
                btn.className = 'nsm-dp-day';
                btn.textContent = day;
                const thisDate = new Date(npmState.dpViewYear, npmState.dpViewMonth, day);
                if (thisDate.getTime() === todayRef.getTime()) btn.classList.add('today');
                if (npmState.selectedDate.getDate() === day && npmState.selectedDate.getMonth() === npmState.dpViewMonth && npmState.selectedDate.getFullYear() === npmState.dpViewYear) {
                    btn.classList.add('selected');
                }
                btn.onclick = () => {
                    npmState.selectedDate = new Date(npmState.dpViewYear, npmState.dpViewMonth, day);
                    updateNpmDateLabel();
                    updateNpmRepeatLabels();
                    renderNpmDatepicker();
                    document.getElementById('npmDatepicker').classList.remove('show');
                };
                grid.appendChild(btn);
            }
            const totalCells = firstDay + daysInMonth;
            const remaining = (7 - (totalCells % 7)) % 7;
            for (let i = 1; i <= remaining; i++) {
                const btn = document.createElement('button');
                btn.className = 'nsm-dp-day other-month';
                btn.textContent = i;
                grid.appendChild(btn);
            }
        }

        // ===== Time picker (Post) =====
        function toggleNpmTimePicker(e) {
            e.stopPropagation();
            const picker = document.getElementById('npmTimePicker');
            const wasOpen = picker.classList.contains('show');
            closeAllNpmPopovers();
            if (!wasOpen) { picker.classList.add('show'); buildNpmTimeWheels(); }
        }

        function buildNpmTimeWheels() {
            buildWheelCol('npmHourWheel', NTP_HOURS, npmState.selectedHour, v => String(v), val => {
                npmState.selectedHour = val; updateNpmTimeLabel();
            });
            buildWheelCol('npmMinWheel', NTP_MINS, npmState.selectedMin, v => String(v).padStart(2,'0'), val => {
                npmState.selectedMin = val; updateNpmTimeLabel();
            });
            buildWheelCol('npmPeriodWheel', NTP_PERIODS, npmState.selectedPeriod, v => v, val => {
                npmState.selectedPeriod = val; updateNpmTimeLabel();
            });
        }

        function updateNpmTimeLabel() {
            const label = `${npmState.selectedHour}:${String(npmState.selectedMin).padStart(2, '0')} ${npmState.selectedPeriod}`;
            document.getElementById('npmTimeLabel').textContent = label;
        }

        // ===== Repeat (Post) =====
        function toggleNpmRepeat(e) {
            e.stopPropagation();
            const dd = document.getElementById('npmRepeatDropdown');
            const wasOpen = dd.classList.contains('show');
            closeAllNpmPopovers();
            if (!wasOpen) dd.classList.add('show');
        }

        function selectNpmRepeat(btn, label) {
            const text = label || btn.textContent;
            document.querySelectorAll('#npmRepeatDropdown .nsm-repeat-option').forEach(o => o.classList.remove('active'));
            btn.classList.add('active');
            npmState.repeatOption = text;
            document.getElementById('npmRepeatLabel').textContent = text;
            document.getElementById('npmRepeatDropdown').classList.remove('show');
            if (text === 'Custom...') alert('Custom repeat configuration coming soon!');
        }

        // Close all post modal sub-popovers
        function closeAllNpmPopovers() {
            document.querySelectorAll('#newPostModal .nsm-datepicker, #newPostModal .nsm-repeat-dropdown, #newPostModal .nsm-tz-popover, #newPostModal .nsm-time-picker').forEach(el => el.classList.remove('show'));
        }

        // ===== Platforms (Post) — all sections always visible, select/deselect via toggle =====
        // Platform display order (fixed)
        const PLATFORM_ORDER = ['instagram', 'facebook', 'youtube', 'tiktok'];

        function toggleNpmPlatform(plat) {
            saveNpmPlatformFormData();
            const section = document.querySelector(`#npmPlatformSections .npm-plat-section[data-plat="${plat}"]`);
            if (!section) { renderNpmPlatformSections(); return; } // Fallback: full re-render

            const idx = npmState.selectedPlatforms.indexOf(plat);
            if (idx !== -1) {
                // Deselect → collapse and remove body
                npmState.selectedPlatforms.splice(idx, 1);
                section.classList.remove('selected');
                section.classList.add('collapsed');
                npmSectionCollapsed[plat] = true;
                const body = section.querySelector('.npm-plat-body');
                if (body) body.remove();
            } else {
                // Select → expand and build body
                npmState.selectedPlatforms.push(plat);
                section.classList.add('selected');
                section.classList.remove('collapsed');
                npmSectionCollapsed[plat] = false;
                if (!section.querySelector('.npm-plat-body')) {
                    const body = document.createElement('div');
                    body.className = 'npm-plat-body';
                    body.innerHTML = buildPlatformFields(plat, npmState.platformData[plat]);
                    section.appendChild(body);
                    attachPlatformListeners(section, plat);
                }
            }
            updateNpmScheduleBtn();
        }

        function updateNpmScheduleBtn() {
            const btn = document.getElementById('npmScheduleBtn');
            const hasContent = npmState.selectedContent !== null;
            const hasPlatform = npmState.selectedPlatforms.length > 0;
            btn.disabled = !(hasContent && hasPlatform);
        }

        // ===== Platform form data persistence =====
        function saveNpmPlatformFormData() {
            // Save data from any currently rendered platform forms
            npmState.selectedPlatforms.forEach(plat => {
                const section = document.querySelector(`.npm-plat-section[data-plat="${plat}"]`);
                if (!section) return;
                const d = npmState.platformData[plat];
                
                if (plat === 'tiktok') {
                    const cap = section.querySelector('[data-field="caption"]');
                    if (cap) d.caption = cap.value;
                }
                if (plat === 'instagram') {
                    const cap = section.querySelector('[data-field="caption"]');
                    if (cap) d.caption = cap.value;
                }
                if (plat === 'youtube') {
                    const t = section.querySelector('[data-field="title"]');
                    const desc = section.querySelector('[data-field="description"]');
                    if (t) d.title = t.value;
                    if (desc) d.description = desc.value;
                }
                if (plat === 'facebook') {
                    const msg = section.querySelector('[data-field="message"]');
                    const link = section.querySelector('[data-field="link"]');
                    if (msg) d.message = msg.value;
                    if (link) d.link = link.value;
                }
            });
        }

        // ===== Render platform sections =====
        const PLATFORM_CONFIG = {
            instagram: { label: 'IG', cls: 'ig', name: 'Instagram',  username: '@meatbar_burger_ig',      brandIcon: '🍔' },
            facebook:  { label: 'FB', cls: 'fb', name: 'Facebook',   username: '@meatbar_burger_official', brandIcon: '🍔' },
            youtube:   { label: 'YT', cls: 'yt', name: 'YouTube',    username: '@MeatBarBurger',           brandIcon: '🍔' },
            tiktok:    { label: 'TT', cls: 'tt', name: 'TikTok',     username: '@meatbar_burger',          brandIcon: '🍔' }
        };

        const YT_CATEGORIES = [
            "Film & Animation","Autos & Vehicles","Music","Pets & Animals","Sports",
            "Travel & Events","Gaming","People & Blogs","Comedy","Entertainment",
            "News & Politics","Howto & Style","Education","Science & Technology",
            "Nonprofits & Activism","Movies","Anime / Animation","Action / Adventure",
            "Classics","Documentary","Drama","Family","Foreign","Horror","Sci-Fi / Fantasy"
        ];

        function renderNpmPlatformSections() {
            const container = document.getElementById('npmPlatformSections');
            // Save collapsed states from existing DOM sections
            container.querySelectorAll('.npm-plat-section').forEach(sec => {
                npmSectionCollapsed[sec.dataset.plat] = sec.classList.contains('collapsed');
            });
            container.innerHTML = '';

            // Show ALL platforms in fixed order
            PLATFORM_ORDER.forEach(plat => {
                const cfg = PLATFORM_CONFIG[plat];
                const isSelected = npmState.selectedPlatforms.includes(plat);
                const d = npmState.platformData[plat];

                const section = document.createElement('div');
                // Selected: auto-expanded unless user manually collapsed. Deselected: always collapsed.
                const isCollapsed = isSelected ? (npmSectionCollapsed[plat] === true) : true;
                section.className = `npm-plat-section${isSelected ? ' selected' : ''}${isCollapsed ? ' collapsed' : ''}`;
                section.dataset.plat = plat;

                // Header with checkbox toggle + thumbnail + name/username + collapse arrow
                const header = document.createElement('div');
                header.className = 'npm-plat-header';
                header.innerHTML = `
                    <div class="npm-plat-header-left">
                        <div class="npm-plat-toggle" data-plat="${plat}">
                            <span class="npm-plat-toggle-check">✓</span>
                        </div>
                        <div class="npm-account-thumb">
                            ${cfg.brandIcon}
                            <span class="npm-account-badge ${cfg.cls}">${cfg.label}</span>
                        </div>
                        <div class="npm-plat-info">
                            <span class="npm-plat-name">${cfg.name}</span>
                            <span class="npm-plat-username">${cfg.username}</span>
                        </div>
                    </div>
                    <span class="npm-plat-collapse-arrow">▾</span>
                `;

                // Toggle checkbox click
                const toggleBtn = header.querySelector('.npm-plat-toggle');
                toggleBtn.onclick = (e) => {
                    e.stopPropagation();
                    toggleNpmPlatform(plat);
                };

                // Header click: toggle if unselected, collapse/expand if selected
                header.onclick = (e) => {
                    if (e.target.closest('.npm-plat-toggle')) return;
                    const currentlySelected = section.classList.contains('selected');
                    if (!currentlySelected) {
                        toggleNpmPlatform(plat);
                        return;
                    }
                    section.classList.toggle('collapsed');
                    npmSectionCollapsed[plat] = section.classList.contains('collapsed');
                };
                section.appendChild(header);

                // Body (only build fields if selected — saves DOM)
                if (isSelected) {
                    const body = document.createElement('div');
                    body.className = 'npm-plat-body';
                    body.innerHTML = buildPlatformFields(plat, d);
                    section.appendChild(body);
                }

                container.appendChild(section);

                // Attach event listeners after inserting into DOM
                if (isSelected) {
                    attachPlatformListeners(section, plat);
                }
            });
        }

        function buildPlatformFields(plat, d) {
            if (plat === 'tiktok') return buildTikTokFields(d);
            if (plat === 'instagram') return buildInstagramFields(d);
            if (plat === 'youtube') return buildYouTubeFields(d);
            if (plat === 'facebook') return buildFacebookFields(d);
            return '';
        }

        // ===== TikTok fields =====
        function buildTikTokFields(d) {
            return `
                <div class="npm-field">
                    <label class="npm-field-label">Caption</label>
                    <div class="npm-hashtag-wrap">
                        <div class="npm-hashtag-backdrop"></div>
                        <textarea class="npm-field-textarea npm-hashtag-input" data-field="caption" placeholder="Write your caption... #hashtags @mentions" maxlength="2200" rows="3">${d.caption}</textarea>
                    </div>
                    <div class="npm-char-count"><span class="npm-caption-count">${d.caption.length}</span> / 2200</div>
                </div>
                <div class="npm-field">
                    <label class="npm-field-label">Privacy Level</label>
                    <div class="npm-radio-group" data-field="privacyLevel">
                        <div class="npm-radio-pill${d.privacyLevel==='Public' ? ' active' : ''}" data-value="Public">Public</div>
                        <div class="npm-radio-pill${d.privacyLevel==='Friends' ? ' active' : ''}" data-value="Friends">Friends</div>
                        <div class="npm-radio-pill${d.privacyLevel==='Private' ? ' active' : ''}" data-value="Private">Private</div>
                    </div>
                </div>
                <div class="npm-divider"></div>
                ${buildToggle('disableDuet', 'Disable Duet', d.disableDuet, 'Prevents other users from creating Duet videos with your content.')}
                ${buildToggle('disableStitch', 'Disable Stitch', d.disableStitch, 'Prevents other users from using clips of your video in their Stitch videos.')}
                ${buildToggle('disableComments', 'Disable Comments', d.disableComments, 'Turns off all comments on this video.')}
                <div class="npm-divider"></div>
                ${buildToggle('brandContent', 'Brand Content', d.brandContent, 'Paid partnership — set to true if this is a paid promotion for a third-party business.')}
                ${buildToggle('brandOrganic', 'Brand Organic', d.brandOrganic, "Promotional content — set to true if this content promotes the creator's own business or brand.")}
                <div class="npm-divider"></div>
                ${buildToggle('aiGenerated', 'AI Generated Content', d.aiGenerated, 'The video will be labelled with a "Creator labeled as AI-generated" tag in the description.')}
            `;
        }

        // ===== Instagram fields =====
        function buildInstagramFields(d) {
            return `
                <div class="npm-field">
                    <label class="npm-field-label">Caption</label>
                    <div class="npm-hashtag-wrap">
                        <div class="npm-hashtag-backdrop"></div>
                        <textarea class="npm-field-textarea npm-hashtag-input" data-field="caption" placeholder="Write your caption..." rows="3">${d.caption}</textarea>
                    </div>
                </div>
                <div class="npm-field">
                    <label class="npm-field-label">Location <span class="npm-optional">(optional)</span></label>
                    <input type="text" class="npm-field-input" data-field="location" value="WIP" disabled>
                </div>
                <div class="npm-field">
                    <label class="npm-field-label">User Tags <span class="npm-optional">(optional)</span></label>
                    <input type="text" class="npm-field-input" data-field="userTags" value="WIP" disabled>
                </div>
                <div class="npm-divider"></div>
                ${buildToggle('shareToFeed', 'Share to Feed', d.shareToFeed, 'Whether reels also show in your main feed alongside regular posts.')}
            `;
        }

        // ===== YouTube fields =====
        function buildYouTubeFields(d) {
            const catOptions = ['<option value="">--- Choose Category ---</option>'].concat(
                YT_CATEGORIES.map(c => `<option value="${c}"${d.category === c ? ' selected' : ''}>${c}</option>`)
            ).join('');

            return `
                <div class="npm-field">
                    <label class="npm-field-label">Title</label>
                    <input type="text" class="npm-field-input" data-field="title" placeholder="Video title" value="${escapeHtml(d.title)}">
                </div>
                <div class="npm-field">
                    <label class="npm-field-label">Description <span class="npm-optional">(optional)</span></label>
                    <div class="npm-hashtag-wrap">
                        <div class="npm-hashtag-backdrop"></div>
                        <textarea class="npm-field-textarea npm-hashtag-input" data-field="description" placeholder="Video description..." rows="4">${d.description}</textarea>
                    </div>
                </div>
                <div class="npm-field">
                    <label class="npm-field-label">Privacy Status</label>
                    <div class="npm-radio-group" data-field="privacyStatus">
                        <div class="npm-radio-pill${d.privacyStatus==='Public' ? ' active' : ''}" data-value="Public">Public</div>
                        <div class="npm-radio-pill${d.privacyStatus==='Private' ? ' active' : ''}" data-value="Private">Private</div>
                        <div class="npm-radio-pill${d.privacyStatus==='Unlisted' ? ' active' : ''}" data-value="Unlisted" style="position:relative;">
                            Unlisted
                            <span class="npm-tooltip" style="margin-left: 4px;">?<span class="npm-tooltip-text">Video is accessible only via direct link. It won't appear in search results or on your channel.</span></span>
                        </div>
                    </div>
                </div>
                <div class="npm-field">
                    <label class="npm-field-label">Tags <span class="npm-optional">(optional)</span></label>
                    <div class="npm-tags-container" data-field="tags">
                        ${d.tags.map((t,i) => `<span class="npm-tag" data-idx="${i}">${escapeHtml(t)}<button class="npm-tag-remove" data-idx="${i}">✕</button></span>`).join('')}
                        <input type="text" class="npm-tags-input" placeholder="${d.tags.length ? '' : 'Type and press Enter to add'}" data-field="tagInput">
                    </div>
                </div>
                <div class="npm-field">
                    <label class="npm-field-label">
                        Category <span class="npm-optional">(optional)</span>
                        <span class="npm-tooltip">?<span class="npm-tooltip-text">Category influences where your video appears on YouTube.\nIt helps YouTube recommend your video to viewers interested in this type of content.</span></span>
                    </label>
                    <select class="npm-field-select" data-field="category">${catOptions}</select>
                </div>
                <div class="npm-divider"></div>
                ${buildToggle('madeForKids', 'Made for Kids', d.madeForKids, "Is this video meant for kids?\nChoose \"Yes\" only if children under 13 are the main audience.\nMarking a video as \"Made for kids\" disables comments, personalized ads, and some features.")}
                ${buildToggle('syntheticMedia', 'Contains Synthetic Media', d.syntheticMedia, "This tells YouTube whether your video includes realistic AI-generated or digitally altered scenes.\nExamples include deepfakes or altered real events.")}
            `;
        }

        // ===== Facebook fields =====
        function buildFacebookFields(d) {
            return `
                <div class="npm-field">
                    <label class="npm-field-label">
                        Post text
                        <span class="npm-tooltip npm-tooltip-below">?<span class="npm-tooltip-text">This is the text that appears with your Facebook post.</span></span>
                    </label>
                    <div class="npm-hashtag-wrap">
                        <div class="npm-hashtag-backdrop"></div>
                        <textarea class="npm-field-textarea npm-hashtag-input" data-field="message" placeholder="What's on your mind?" rows="4">${d.message}</textarea>
                    </div>
                </div>
                <div class="npm-field">
                    <label class="npm-field-label">
                        Link <span class="npm-optional">(optional)</span>
                        <span class="npm-tooltip npm-tooltip-below">?<span class="npm-tooltip-text">Attach a link to share a webpage with a preview.\nFacebook will automatically generate a title, image, and description.</span></span>
                    </label>
                    <input type="text" class="npm-field-input" data-field="link" placeholder="https://..." value="${escapeHtml(d.link)}">
                </div>
            `;
        }

        // ===== Shared builders =====
        function buildToggle(field, label, isOn, tooltip) {
            return `
                <div class="npm-toggle-row">
                    <span class="npm-toggle-label">
                        ${label}
                        ${tooltip ? `<span class="npm-tooltip">?<span class="npm-tooltip-text">${tooltip}</span></span>` : ''}
                    </span>
                    <div class="npm-toggle-switch${isOn ? ' on' : ''}" data-toggle="${field}"></div>
                </div>
            `;
        }

        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
        }

        // Render text with hashtags wrapped in <span class="hashtag">
        function renderHashtagHighlight(text) {
            if (!text) return '';
            return escapeHtml(text).replace(/(#\S+)/g, '<span class="hashtag">$1</span>');
        }

        // ===== Local tag re-render (YouTube only) — avoids full modal re-render =====
        function renderYouTubeTags(container, d, section, plat) {
            // Preserve the input element and its value
            const input = container.querySelector('.npm-tags-input');
            const inputVal = input ? input.value : '';
            
            // Remove all existing tags (but not the input)
            container.querySelectorAll('.npm-tag').forEach(t => t.remove());
            
            // Re-insert tags before the input
            d.tags.forEach((tag, i) => {
                const span = document.createElement('span');
                span.className = 'npm-tag';
                span.dataset.idx = i;
                span.innerHTML = `${escapeHtml(tag)}<button class="npm-tag-remove" data-idx="${i}">✕</button>`;
                container.insertBefore(span, input);
            });

            // Update placeholder
            if (input) {
                input.placeholder = d.tags.length ? '' : 'Type and press Enter to add';
                input.value = inputVal;
                input.focus();
            }

            // Re-attach remove listeners
            attachTagRemoveListeners(container, d, section, plat);
        }

        function attachTagRemoveListeners(container, d, section, plat) {
            container.querySelectorAll('.npm-tag-remove').forEach(btn => {
                btn.onclick = (e) => {
                    e.stopPropagation();
                    const idx = parseInt(btn.dataset.idx);
                    d.tags.splice(idx, 1);
                    renderYouTubeTags(container, d, section, plat);
                };
            });
        }

        // ===== Attach event listeners to platform section =====
        function attachPlatformListeners(section, plat) {
            const d = npmState.platformData[plat];

            // Toggles
            section.querySelectorAll('.npm-toggle-switch').forEach(sw => {
                sw.onclick = () => {
                    const field = sw.dataset.toggle;
                    d[field] = !d[field];
                    sw.classList.toggle('on', d[field]);
                };
            });

            // Radio pills
            section.querySelectorAll('.npm-radio-group').forEach(group => {
                const field = group.dataset.field;
                group.querySelectorAll('.npm-radio-pill').forEach(pill => {
                    pill.onclick = (e) => {
                        e.stopPropagation();
                        group.querySelectorAll('.npm-radio-pill').forEach(p => p.classList.remove('active'));
                        pill.classList.add('active');
                        d[field] = pill.dataset.value;
                    };
                });
            });

            // Caption character counter (TikTok)
            if (plat === 'tiktok') {
                const captionEl = section.querySelector('[data-field="caption"]');
                const counter = section.querySelector('.npm-caption-count');
                if (captionEl && counter) {
                    captionEl.addEventListener('input', () => {
                        d.caption = captionEl.value;
                        counter.textContent = captionEl.value.length;
                    });
                }
            }

            // Text fields auto-save on input
            section.querySelectorAll('.npm-field-input:not(:disabled), .npm-field-textarea').forEach(input => {
                const field = input.dataset.field;
                if (field && field !== 'tagInput') {
                    input.addEventListener('input', () => { d[field] = input.value; });
                }
            });

            // Hashtag highlight — wire up .npm-hashtag-input textareas
            section.querySelectorAll('.npm-hashtag-input').forEach(textarea => {
                const backdrop = textarea.parentElement.querySelector('.npm-hashtag-backdrop');
                if (!backdrop) return;
                const updateHighlight = () => {
                    backdrop.innerHTML = renderHashtagHighlight(textarea.value);
                };
                textarea.addEventListener('input', updateHighlight);
                textarea.addEventListener('scroll', () => {
                    backdrop.scrollTop = textarea.scrollTop;
                });
                // Initialize
                updateHighlight();
            });

            // Select fields
            section.querySelectorAll('.npm-field-select').forEach(sel => {
                const field = sel.dataset.field;
                sel.addEventListener('change', () => { d[field] = sel.value; });
            });

            // Tags (YouTube)
            if (plat === 'youtube') {
                const tagsContainer = section.querySelector('.npm-tags-container');
                const tagInput = section.querySelector('[data-field="tagInput"]');
                
                if (tagInput) {
                    tagInput.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' && tagInput.value.trim()) {
                            e.preventDefault();
                            d.tags.push(tagInput.value.trim());
                            tagInput.value = '';
                            renderYouTubeTags(tagsContainer, d, section, plat);
                        }
                        if (e.key === 'Backspace' && !tagInput.value && d.tags.length > 0) {
                            d.tags.pop();
                            renderYouTubeTags(tagsContainer, d, section, plat);
                        }
                    });
                }

                // Tag remove buttons — attach via delegation
                attachTagRemoveListeners(tagsContainer, d, section, plat);

                // Click container to focus input
                if (tagsContainer) {
                    tagsContainer.onclick = () => tagInput && tagInput.focus();
                }
            }
        }

        // ===== Content picker (Post) — uses unified picker =====
        function openPostContentPicker() {
            openUnifiedContentPicker('post');
        }

        function pickContentForPost(item) {
            npmState.selectedContent = item;
            contentPickTarget = null;
            document.getElementById('contentPickOverlay').classList.remove('active');
            document.getElementById('contentDrawer').classList.remove('nsm-picking');
            document.getElementById('contentDrawer').classList.remove('open');
            cleanupContentPicking();
            renderNpmContent();
            updateNpmScheduleBtn();
        }

        function renderNpmContent() {
            const placeholder = document.getElementById('npmPlaceholder');
            const filled = document.getElementById('npmContentFilled');
            const removeBtn = document.getElementById('npmRemoveContent');
            const preview = document.getElementById('npmContentPreview');
            
            if (npmState.selectedContent) {
                placeholder.style.display = 'none';
                filled.style.display = 'flex';
                removeBtn.style.display = 'flex';
                preview.classList.add('has-content');
                filled.className = `nsm-content-filled ${npmState.selectedContent.gradClass || 'grad-blur-1'}`;
                filled.innerHTML = `<div class="filled-title">${npmState.selectedContent.title}</div>`;
            } else {
                placeholder.style.display = 'flex';
                filled.style.display = 'none';
                removeBtn.style.display = 'none';
                preview.classList.remove('has-content');
            }
            updateNpmScheduleBtn();
        }

        function removePostContent(e) {
            e.stopPropagation();
            npmState.selectedContent = null;
            renderNpmContent();
        }

        // ===== Setup drag-drop for post content preview =====
        function setupPostContentPreviewDrop() {
            const preview = document.getElementById('npmContentPreview');
            const overlay = document.getElementById('contentPickOverlay');
            const modal = document.querySelector('.new-post-modal');
            
            preview.addEventListener('dragover', e => {
                e.preventDefault(); e.stopPropagation();
                e.dataTransfer.dropEffect = 'copy';
                preview.classList.add('drop-hover');
            });
            preview.addEventListener('dragleave', e => {
                e.stopPropagation();
                preview.classList.remove('drop-hover');
            });
            preview.addEventListener('drop', e => {
                e.preventDefault(); e.stopPropagation();
                preview.classList.remove('drop-hover');
                handlePostContentDrop(e);
            });

            overlay.addEventListener('dragover', e => {
                if (contentPickTarget !== 'post' || !pickClone) return;
                const cloneRect = pickClone.getBoundingClientRect();
                const isOnClone = e.clientX >= cloneRect.left && e.clientX <= cloneRect.right && e.clientY >= cloneRect.top && e.clientY <= cloneRect.bottom;
                if (isOnClone) {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'copy';
                    pickClone.style.borderStyle = 'solid';
                    pickClone.style.background = CLONE_BG_HOVER;
                } else {
                    e.dataTransfer.dropEffect = 'none';
                    if (pickClone) { pickClone.style.borderStyle = 'dashed'; pickClone.style.background = CLONE_BG; }
                }
            });
            overlay.addEventListener('dragleave', e => {
                if (contentPickTarget !== 'post' || !pickClone) return;
                pickClone.style.borderStyle = 'dashed';
                pickClone.style.background = CLONE_BG;
            });
            overlay.addEventListener('drop', e => {
                if (contentPickTarget !== 'post' || !pickClone) return;
                const cloneRect = pickClone.getBoundingClientRect();
                const isOnClone = e.clientX >= cloneRect.left && e.clientX <= cloneRect.right && e.clientY >= cloneRect.top && e.clientY <= cloneRect.bottom;
                if (isOnClone) {
                    e.preventDefault();
                    handlePostContentDrop(e);
                }
            });
        }
        
        function handlePostContentDrop(e) {
            let item = null;
            try { item = JSON.parse(e.dataTransfer.getData('item')); } catch(err) {}
            if (item) {
                if (contentPickTarget === 'post') {
                    pickContentForPost(item);
                } else {
                    npmState.selectedContent = item;
                    renderNpmContent();
                }
            }
        }

        // Init post content preview drop
        setupPostContentPreviewDrop();

        // ===== Update content card click handler — unified for both Story and Post picking =====
        const _origUpdateContentList = updateContentList;
        updateContentList = function() {
            _origUpdateContentList();
            // Re-attach click handlers that check unified contentPickTarget
            document.querySelectorAll('.content-card').forEach(card => {
                const origOnClick = card.onclick;
                card.onclick = (e) => {
                    if (!card.classList.contains('dragging')) {
                        let item = null;
                        try { item = JSON.parse(card.dataset.item); } catch(err) {}
                        // Always open preview modal — picking is done via drag-and-drop only
                        if (item) {
                            openModal(item);
                            return;
                        }
                    }
                    if (origOnClick) origOnClick(e);
                };
            });
        };

        // Click-away for post modal sub-popovers
        document.addEventListener('click', (e) => {
            if (e.target.closest('.new-post-modal') && !e.target.closest('.nsm-chip') && !e.target.closest('.nsm-datepicker') && !e.target.closest('.nsm-repeat-dropdown') && !e.target.closest('.nsm-tz-popover') && !e.target.closest('.nsm-time-picker')) {
                closeAllNpmPopovers();
            }
        });

        // Escape key closes modals
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (document.getElementById('dragTypePicker').classList.contains('show')) {
                    document.getElementById('dragTypePicker').classList.remove('show');
                } else if (contentPickTarget) {
                    cancelContentPicking();
                } else if (document.getElementById('newPostModal').classList.contains('active')) {
                    const openPopovers = document.querySelectorAll('#newPostModal .nsm-datepicker.show, #newPostModal .nsm-repeat-dropdown.show, #newPostModal .nsm-time-picker.show');
                    if (openPopovers.length > 0) {
                        closeAllNpmPopovers();
                    } else {
                        closeNewPostModal();
                    }
                } else if (document.getElementById('newStoryModal').classList.contains('active')) {
                    closeNewStoryModal();
                }
            }
        });
    </script>
</body>
</html>